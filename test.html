<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Library — Patholytica</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-color: #0f0f0f;
  --text-primary: #fff;
  --text-secondary: #aaa;
  --card-bg: #1f1f1f;
  --hover-bg: #2a2a2a;
  --border-color: #303030;
  --accent: #3ea6ff;
  --accent-hover: #2d8ed6;
  --accent-purple: #9b59b6;
  --accent-green: #2ecc71;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  min-height: 100%;
  font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
  overflow-x: hidden;
  max-width: 100vw;
}

body {
  background: var(--bg-color);
  color: var(--text-primary);
  transition: background 0.2s ease, color 0.2s ease;
}

.header-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--card-bg);
  padding-top: env(safe-area-inset-top);
  z-index: 40;
  width: 100%;
  height: 0.25px;
  pointer-events: none;
}

.header {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 4px 16px;
  max-width: 100%;
  margin: 0 auto;
  height: 100%;
  pointer-events: none;
}

/* Main Container */
.main-container {
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
  padding: 40px 24px 100px;
}

/* Library Header */
.library-header {
  margin-bottom: 40px;
}

.library-icon {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, var(--accent-purple) 0%, #8e44ad 100%);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  color: white;
  box-shadow: 0 8px 24px rgba(155, 89, 182, 0.4);
  margin-bottom: 24px;
}

.library-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 42px;
  font-weight: 700;
  margin: 0 0 12px 0;
  color: var(--text-primary);
  line-height: 1.2;
}

.library-meta {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.library-author {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: color 0.2s ease;
}

.library-author:hover {
  color: var(--accent);
}

.author-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  color: white;
}

.library-stats {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.stat-item i {
  font-size: 12px;
}

.library-description {
  font-size: 16px;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 24px;
}

.library-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.action-btn {
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent-purple) 0%, #8e44ad 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
}

.btn-secondary {
  background: var(--card-bg);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
}

.btn-secondary:hover {
  background: var(--hover-bg);
}

/* Articles Section */
.articles-section {
  margin-top: 48px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.section-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
}

.article-count {
  font-size: 14px;
  color: var(--text-secondary);
}

.articles-grid {
  display: grid;
  gap: 20px;
}

.article-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 20px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.article-card:hover {
  border-color: var(--accent-purple);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

.article-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 16px;
}

.article-number {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--accent-purple) 0%, #8e44ad 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}

.article-info {
  flex: 1;
  min-width: 0;
}

.article-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  line-height: 1.3;
}

.article-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 13px;
  color: var(--text-secondary);
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.article-excerpt {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.5;
  margin-top: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.article-actions {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border-color);
}

.article-action-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
  background: none;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 6px 12px;
  border-radius: 8px;
}

.article-action-btn:hover {
  color: var(--text-primary);
  background: var(--hover-bg);
}

.article-action-btn.liked {
  color: #ef4444;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-secondary);
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.empty-text {
  font-size: 14px;
  margin-bottom: 24px;
}

/* Loading State */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  color: var(--text-secondary);
}

.loading-spinner {
  width: 48px;
  height: 48px;
  margin-bottom: 20px;
  border: 4px solid var(--border-color);
  border-top-color: var(--accent-purple);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Footer Bar Navigation */
.footer-bar {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 450px;
  background: var(--card-bg);
  border-top: 1px solid var(--border-color);
  padding: 8px 24px;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 100;
}

.footer-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  transition: color 0.2s ease;
  padding: 6px 12px;
}

.footer-btn:hover {
  color: var(--text-primary);
}

.footer-btn.active {
  color: var(--accent);
}

.footer-btn i {
  font-size: 20px;
}

.footer-btn span {
  font-size: 10px;
  font-weight: 500;
}

/* Responsive */
@media (max-width: 768px) {
  .main-container {
    padding: 24px 16px 100px;
  }

  .library-title {
    font-size: 32px;
  }

  .library-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .library-actions {
    width: 100%;
  }

  .action-btn {
    flex: 1;
    justify-content: center;
  }

  .article-title {
    font-size: 16px;
  }
}
</style>
</head>
<body>

<div class="header-wrapper">
  <div class="header">
  </div>
</div>

<div class="main-container">
  <div id="loadingState" class="loading-container">
    <div class="loading-spinner"></div>
    <div>Loading library...</div>
  </div>

  <div id="libraryContent" style="display: none;">
    <div class="library-header">
      <div class="library-icon">
        <i class="fas fa-bookmark"></i>
      </div>
      <h1 class="library-title" id="libraryTitle">Library Title</h1>
      
      <div class="library-meta">
        <div class="library-author" id="libraryAuthor">
          <div class="author-avatar">A</div>
          <span>@username</span>
        </div>
        <div class="library-stats">
          <div class="stat-item">
            <i class="fas fa-file-alt"></i>
            <span id="articleCount">0 articles</span>
          </div>
          <div class="stat-item">
            <i class="fas fa-clock"></i>
            <span id="createdDate">Jan 1, 2024</span>
          </div>
        </div>
      </div>

      <p class="library-description" id="libraryDescription"></p>

      <div class="library-actions">
        <button class="action-btn btn-primary" id="playAllBtn">
          <i class="fas fa-play"></i>
          Play All
        </button>
        <button class="action-btn btn-secondary" id="shareBtn">
          <i class="fas fa-share"></i>
          Share
        </button>
        <button class="action-btn btn-secondary" id="editBtn" style="display: none;">
          <i class="fas fa-edit"></i>
          Edit
        </button>
      </div>
    </div>

    <div class="articles-section">
      <div class="section-header">
        <h2 class="section-title">Articles</h2>
        <div class="article-count" id="articleCountText">0 articles</div>
      </div>
      <div class="articles-grid" id="articlesGrid"></div>
    </div>
  </div>

  <div id="emptyState" class="empty-state" style="display: none;">
    <div class="empty-icon">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <div class="empty-title">Library not found</div>
    <div class="empty-text">This library doesn't exist or has been removed.</div>
    <button class="action-btn btn-primary" onclick="window.location.href='index.html'">
      <i class="fas fa-home"></i>
      Go Home
    </button>
  </div>
</div>

<div class="footer-bar">
  <button class="footer-btn" onclick="window.location.href='index.html'">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='dailyfeed.html'">
    <i class="fas fa-scroll"></i>
    <span>Feed</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='explore.html'">
    <i class="fas fa-search"></i>
    <span>Explore</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='profile.html'">
    <i class="fas fa-user"></i>
    <span>Profile</span>
  </button>
</div>

<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Initialize Supabase
const SUPABASE_URL = "https://vduqewqyvszfquntmark.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdXFld3F5dnN6ZnF1bnRtYXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU5NTE1MDEsImV4cCI6MjA1MTUyNzUwMX0.gs_0CufW-D4CBdcBHyPztOlcgLCBdhnXj7c";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Global variables
let currentUser = null;
let currentUserData = null;
let libraryData = null;
let libraryId = null;

// Get library ID from URL
const urlParams = new URLSearchParams(window.location.search);
libraryId = urlParams.get('id');

console.log('=== LIBRARY PAGE DEBUG ===');
console.log('Library ID from URL:', libraryId);
console.log('Full URL:', window.location.href);

// Helper function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Load library data
async function loadLibrary() {
  const loadingState = document.getElementById('loadingState');
  const libraryContent = document.getElementById('libraryContent');
  const emptyState = document.getElementById('emptyState');
  const articlesGrid = document.getElementById('articlesGrid');

  console.log('--- Starting loadLibrary function ---');
  console.log('Loading library with ID:', libraryId);

  try {
    // Fetch library details
    console.log('Fetching library from playlists table...');
    const { data: library, error: libraryError } = await supabase
      .from('playlists')
      .select('*')
      .eq('id', libraryId)
      .single();

    console.log('Library query result:', { library, error: libraryError });

    if (libraryError) {
      console.error('❌ Error fetching library:', libraryError);
      console.error('Error code:', libraryError.code);
      console.error('Error message:', libraryError.message);
      console.error('Error details:', libraryError.details);
      console.error('Error hint:', libraryError.hint);
      loadingState.style.display = 'none';
      emptyState.style.display = 'block';
      return;
    }

    if (!library) {
      console.error('❌ Library not found - query returned null/undefined');
      loadingState.style.display = 'none';
      emptyState.style.display = 'block';
      return;
    }

    console.log('✅ Library found successfully:', library);
    libraryData = library;

    // Fetch library creator
    console.log('Fetching library creator with user_id:', library.user_id);
    const { data: creator, error: creatorError } = await supabase
      .from('users')
      .select('user_id, username, full_name')
      .eq('user_id', library.user_id)
      .single();

    console.log('Creator query result:', { creator, error: creatorError });
    if (creatorError) {
      console.warn('⚠️ Error fetching creator (non-fatal):', creatorError);
    }

    // Fetch articles in library
    console.log('Fetching playlist items...');
    const { data: playlistItems, error: itemsError } = await supabase
      .from('playlist_items')
      .select('article_id, created_at')
      .eq('playlist_id', libraryId)
      .order('created_at', { ascending: true });

    console.log('Playlist items query result:', { playlistItems, error: itemsError });

    if (itemsError) {
      console.error('❌ Error fetching playlist items:', itemsError);
      throw itemsError;
    }

    let articles = [];
    if (playlistItems && playlistItems.length > 0) {
      console.log(`Found ${playlistItems.length} playlist items`);
      const articleIds = playlistItems.map(item => item.article_id);
      console.log('Article IDs to fetch:', articleIds);
      
      const { data: articlesData, error: articlesError } = await supabase
        .from('articles')
        .select('*')
        .in('id', articleIds);

      console.log('Articles query result:', { articlesData, error: articlesError });

      if (articlesError) {
        console.error('❌ Error fetching articles:', articlesError);
        throw articlesError;
      }

      // Maintain order from playlist_items
      articles = playlistItems.map(item => {
        return articlesData.find(a => a.id === item.article_id);
      }).filter(a => a !== undefined);

      console.log(`Matched ${articles.length} articles from playlist items`);

      // Fetch authors for articles
      const authorIds = [...new Set(articles.map(a => a.firebase_user_id).filter(id => id))];
      console.log('Author IDs to fetch:', authorIds);
      
      let authorsMap = {};
      
      if (authorIds.length > 0) {
        const { data: authors, error: authorsError } = await supabase
          .from('users')
          .select('firebase_uid, username, full_name')
          .in('firebase_uid', authorIds);
        
        console.log('Authors query result:', { authors, error: authorsError });
        
        if (authors) {
          authors.forEach(author => {
            authorsMap[author.firebase_uid] = author;
          });
          console.log('Authors map created:', authorsMap);
        }
      }

      articles = articles.map(article => {
        const author = authorsMap[article.firebase_user_id];
        return {
          ...article,
          author: author?.username ? `@${author.username}` : (author?.full_name || 'Anonymous')
        };
      });

      console.log('Final articles with author info:', articles);
    } else {
      console.log('No playlist items found');
    }

    console.log('✅ Successfully loaded all data, calling displayLibrary...');
    displayLibrary(library, creator, articles);

  } catch (error) {
    console.error('❌ FATAL ERROR in loadLibrary:', error);
    console.error('Error stack:', error.stack);
    loadingState.style.display = 'none';
    emptyState.style.display = 'block';
  }
}

function displayLibrary(library, creator, articles) {
  console.log('--- Starting displayLibrary function ---');
  console.log('Library:', library);
  console.log('Creator:', creator);
  console.log('Articles count:', articles.length);

  const loadingState = document.getElementById('loadingState');
  const libraryContent = document.getElementById('libraryContent');
  const articlesGrid = document.getElementById('articlesGrid');

  // Update library info
  document.getElementById('libraryTitle').textContent = library.name;
  console.log('Set library title:', library.name);
  
  if (library.description) {
    document.getElementById('libraryDescription').textContent = library.description;
    document.getElementById('libraryDescription').style.display = 'block';
    console.log('Set library description:', library.description);
  } else {
    document.getElementById('libraryDescription').style.display = 'none';
    console.log('No description provided');
  }

  // Update author
  if (creator) {
    const authorName = creator.username ? `@${creator.username}` : (creator.full_name || 'Anonymous');
    document.getElementById('libraryAuthor').querySelector('span').textContent = authorName;
    document.getElementById('libraryAuthor').querySelector('.author-avatar').textContent = authorName.charAt(0).toUpperCase();
    document.getElementById('libraryAuthor').onclick = () => {
      window.location.href = `profile.html?user=${creator.user_id}`;
    };
    console.log('Set author:', authorName);
  } else {
    console.log('No creator found');
  }

  // Update stats
  document.getElementById('articleCount').textContent = `${articles.length} article${articles.length !== 1 ? 's' : ''}`;
  document.getElementById('articleCountText').textContent = `${articles.length} article${articles.length !== 1 ? 's' : ''}`;
  
  const createdDate = new Date(library.created_at);
  document.getElementById('createdDate').textContent = createdDate.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
  console.log('Set stats - articles:', articles.length, 'created:', createdDate);

  // Show edit button if user owns library
  if (currentUserData && currentUserData.user_id === library.user_id) {
    document.getElementById('editBtn').style.display = 'flex';
    console.log('User owns library - showing edit button');
  }

  // Display articles
  if (articles.length === 0) {
    articlesGrid.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="empty-title">No articles yet</div>
        <div class="empty-text">This library doesn't have any articles yet.</div>
      </div>
    `;
    console.log('No articles to display');
  } else {
    articlesGrid.innerHTML = '';
    articles.forEach((article, index) => {
      const card = createArticleCard(article, index + 1);
      articlesGrid.appendChild(card);
    });
    console.log(`Rendered ${articles.length} article cards`);
  }

  // Setup action buttons
  document.getElementById('playAllBtn').onclick = () => {
    if (articles.length > 0) {
      console.log('Play All clicked - navigating to first article:', articles[0].id);
      window.location.href = `article.html?id=${articles[0].id}`;
    }
  };

  document.getElementById('shareBtn').onclick = () => {
    const url = window.location.href;
    console.log('Share clicked - URL:', url);
    if (navigator.share) {
      navigator.share({
        title: library.name,
        text: library.description || 'Check out this library on Patholytica',
        url: url
      });
    } else {
      navigator.clipboard.writeText(url);
      alert('Link copied to clipboard!');
    }
  };

  document.getElementById('editBtn').onclick = () => {
    console.log('Edit clicked - navigating to edit page');
    window.location.href = `edit-library.html?id=${libraryId}`;
  };

  // Show content
  loadingState.style.display = 'none';
  libraryContent.style.display = 'block';
  console.log('✅ Library display complete');
}

function createArticleCard(article, number) {
  const card = document.createElement('div');
  card.className = 'article-card';
  
  const createdDate = new Date(article.created_at);
  const formattedDate = createdDate.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });

  const excerpt = article.content ? article.content.substring(0, 150) + '...' : '';

  card.innerHTML = `
    <div class="article-header">
      <div class="article-number">${number}</div>
      <div class="article-info">
        <h3 class="article-title">${escapeHtml(article.title || 'Untitled')}</h3>
        <div class="article-meta">
          <div class="meta-item">
            <i class="fas fa-user"></i>
            <span>${article.author}</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-calendar"></i>
            <span>${formattedDate}</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-eye"></i>
            <span>${article.views || 0}</span>
          </div>
        </div>
      </div>
    </div>
    ${excerpt ? `<div class="article-excerpt">${escapeHtml(excerpt)}</div>` : ''}
    <div class="article-actions">
      <button class="article-action-btn">
        <i class="fas fa-heart"></i>
        <span>${article.likes || 0}</span>
      </button>
      <button class="article-action-btn">
        <i class="fas fa-comment"></i>
        <span>0</span>
      </button>
      <button class="article-action-btn">
        <i class="fas fa-share"></i>
        <span>Share</span>
      </button>
    </div>
  `;

  card.onclick = (e) => {
    if (!e.target.closest('.article-action-btn')) {
      console.log('Article card clicked - navigating to:', article.id);
      window.location.href = `article.html?id=${article.id}`;
    }
  };

  return card;
}

// Check authentication and load library
onAuthStateChanged(auth, async (user) => {
  console.log('--- Auth state changed ---');
  console.log('User:', user ? user.uid : 'null');
  
  if (user) {
    currentUser = user;
    
    try {
      const { data: userData, error } = await supabase
        .from('users')
        .select('*')
        .eq('firebase_uid', user.uid)
        .single();
      
      console.log('User data query result:', { userData, error });
      
      if (!error) {
        currentUserData = userData;
        console.log('Current user data set:', currentUserData);
      }
    } catch (error) {
      console.error('Error fetching user data:', error);
    }
  } else {
    console.log('No user logged in');
  }
  
  // Load library regardless of auth state (public viewing)
  if (libraryId) {
    console.log('Library ID present - calling loadLibrary');
    loadLibrary();
  } else {
    console.error('❌ No library ID in URL');
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
  }
});

console.log('=== Script loaded successfully ===');
</script>

</body>
</html>