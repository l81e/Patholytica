<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica — Library</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-color: #0d0d0f;
  --bg-secondary: #16161a;
  --bg-tertiary: #1e1e24;
  --text-primary: #f0f0f5;
  --text-secondary: #8888a0;
  --text-muted: #555568;
  --card-bg: #16161a;
  --card-bg-raised: #1e1e24;
  --hover-bg: #252530;
  --border-color: #2a2a36;
  --border-bright: #3a3a4a;
  --accent: #4f8fff;
  --accent-hover: #3a7aee;
  --accent-glow: rgba(79,143,255,0.15);
  --accent-green: #2ecc71;
  --accent-green-glow: rgba(46,204,113,0.15);
  --accent-purple: #a855f7;
  --accent-purple-glow: rgba(168,85,247,0.15);
  --accent-red: #ef4444;
  --header-bg: rgba(13,13,15,0.92);
}

body.light-theme {
  --bg-color: #f0f0f5;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f8f8fc;
  --text-primary: #0f0f1a;
  --text-secondary: #5a5a72;
  --text-muted: #9090a8;
  --card-bg: #ffffff;
  --card-bg-raised: #f8f8fc;
  --hover-bg: #f0f0f8;
  --border-color: #e0e0ee;
  --border-bright: #c8c8dc;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --accent-glow: rgba(37,99,235,0.08);
  --accent-green: #16a34a;
  --accent-purple: #7c3aed;
  --header-bg: rgba(240,240,245,0.92);
}

* { box-sizing: border-box; }
html, body {
  margin: 0;
  padding: 0;
  min-height: 100%;
  font-family: "Inter", "Roboto", Arial, sans-serif;
  overflow-x: hidden;
  max-width: 100vw;
}
body {
  background: var(--bg-color);
  color: var(--text-primary);
  transition: background 0.2s ease, color 0.2s ease;
}

/* ── Header ── */
.header-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--header-bg);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border-color);
  z-index: 40;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 24px;
  max-width: 900px;
  margin: 0 auto;
}
.logo-img {
  height: 28px;
  width: auto;
  cursor: pointer;
  transition: opacity 0.2s ease;
}
.logo-img:hover { opacity: 0.75; }
body.light-theme .logo-img { filter: invert(1); }

.header-actions { display: flex; align-items: center; gap: 12px; }
.icon-btn {
  width: 38px; height: 38px;
  border-radius: 50%;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  transition: all 0.2s ease;
}
.icon-btn:hover { background: var(--hover-bg); border-color: var(--border-bright); }

.auth-buttons { display: none; gap: 10px; }
.auth-buttons.show { display: flex; }
.btn-login {
  padding: 8px 18px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  border: 1px solid var(--border-bright);
  background: var(--bg-tertiary);
  color: var(--text-primary);
}
.btn-login:hover { background: var(--hover-bg); border-color: var(--accent); color: var(--accent); }

.user-welcome { display: none; align-items: center; gap: 10px; }
.user-welcome.show { display: flex; }
.welcome-pill {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.2s ease;
}
.welcome-pill:hover { background: var(--accent-glow); border-color: var(--accent); }
.welcome-pill i { font-size: 11px; opacity: 0.7; }

/* ── FAB ── */
.fab-create {
  position: fixed;
  bottom: 84px; right: 20px;
  width: 54px; height: 54px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  color: white;
  border: none;
  cursor: pointer;
  display: none;
  align-items: center; justify-content: center;
  font-size: 22px;
  box-shadow: 0 4px 20px rgba(79,143,255,0.35), 0 0 0 1px rgba(79,143,255,0.2);
  transition: all 0.3s ease;
  z-index: 50;
}
.fab-create.show { display: flex; }
.fab-create:hover { transform: scale(1.08) rotate(45deg); box-shadow: 0 6px 24px rgba(79,143,255,0.5); }
.fab-create:active { transform: scale(0.95) rotate(45deg); }

/* ── Create Modal ── */
.create-modal {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center; justify-content: center;
  padding: 20px;
}
.create-modal.show { display: flex; }
.create-modal-content {
  background: var(--card-bg);
  border-radius: 20px;
  width: 100%; max-width: 400px;
  border: 1px solid var(--border-bright);
  box-shadow: 0 24px 64px rgba(0,0,0,0.5);
  overflow: hidden;
}
.create-modal-header {
  padding: 22px 26px;
  border-bottom: 1px solid var(--border-color);
  display: flex; align-items: center; justify-content: space-between;
}
.create-modal-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 20px; font-weight: 700; margin: 0;
}
.create-modal-close {
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--bg-tertiary); border: 1px solid var(--border-color);
  color: var(--text-secondary); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; transition: all 0.2s ease;
}
.create-modal-close:hover { background: var(--hover-bg); color: var(--text-primary); transform: rotate(90deg); }
.create-modal-body { padding: 18px 22px 22px; display: flex; flex-direction: column; gap: 10px; }
.create-option {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 18px;
  border-radius: 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  cursor: pointer; transition: all 0.25s ease;
}
.create-option:hover { border-color: var(--accent); background: var(--accent-glow); transform: translateX(3px); }
.create-option-icon {
  width: 44px; height: 44px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: white; flex-shrink: 0;
}
.create-option-icon.article { background: linear-gradient(135deg, #2ecc71, #27ae60); }
.create-option-icon.library { background: linear-gradient(135deg, #a855f7, #7c3aed); }
.create-option-title { font-size: 16px; font-weight: 600; margin: 0 0 2px 0; color: var(--text-primary); }
.create-option-desc { font-size: 12px; color: var(--text-secondary); margin: 0; }

/* ── Layout ── */
.list-container {
  max-width: 900px; width: 100%;
  margin: 0 auto;
  padding: 24px 24px 0;
  padding-top: calc(57px + env(safe-area-inset-top) + 24px);
}

/* ── Stories ── */
.stories-section { margin-bottom: 28px; }
.stories-scroll {
  display: flex; gap: 14px;
  overflow-x: auto; overflow-y: hidden;
  padding: 4px 0 12px;
  scrollbar-width: none; -ms-overflow-style: none;
}
.stories-scroll::-webkit-scrollbar { display: none; }
.story-item {
  display: flex; flex-direction: column; align-items: center;
  gap: 7px; cursor: pointer; flex-shrink: 0;
  transition: transform 0.2s ease;
}
.story-item:hover { transform: scale(1.06); }
.story-avatar {
  width: 68px; height: 68px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent-purple));
  padding: 2.5px;
  display: flex; align-items: center; justify-content: center;
}
.story-avatar-inner {
  width: 100%; height: 100%; border-radius: 50%;
  background: var(--bg-color);
  padding: 2.5px;
  display: flex; align-items: center; justify-content: center; overflow: hidden;
}
.story-avatar-content {
  width: 100%; height: 100%; border-radius: 50%;
  background: linear-gradient(135deg, var(--bg-tertiary), var(--hover-bg));
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; font-weight: 700; color: var(--accent); overflow: hidden;
}
.story-avatar-content img { width: 100%; height: 100%; object-fit: cover; }
.story-username {
  font-size: 11px; font-weight: 500;
  color: var(--text-secondary);
  max-width: 68px; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis; text-align: center;
}
.story-item.current-user .story-avatar {
  background: linear-gradient(135deg, var(--accent-green), #27ae60);
}
.story-loading {
  width: 68px; height: 68px; border-radius: 50%;
  border: 2.5px solid var(--border-color);
  border-top: 2.5px solid var(--accent-green);
  animation: spin 0.9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ── Hero ── */
.home-hero {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 32px 36px;
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}
.home-hero::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent-purple));
}
.hero-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 30px; font-weight: 700;
  margin: 0 0 16px 0;
  color: var(--text-primary);
  line-height: 1.25;
}
.hero-stats {
  display: flex; align-items: center; gap: 6px;
  margin-bottom: 16px; flex-wrap: wrap;
}
.hero-stat {
  display: flex; align-items: center; gap: 6px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 13px;
}
.hero-stat-value {
  font-weight: 700; font-size: 14px;
  color: var(--accent);
}
.hero-stat-label { color: var(--text-secondary); }
.hero-stat-sep { color: var(--border-bright); margin: 0 2px; }
.hero-description {
  font-size: 14px; line-height: 1.6;
  color: var(--text-secondary); margin: 0;
}

/* ── Section shared ── */
.section-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 26px 30px;
  margin-bottom: 20px;
}
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px;
}
.section-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 20px; font-weight: 700; margin: 0;
  color: var(--text-primary);
}
.section-title-icon {
  display: inline-flex; align-items: center; justify-content: center;
  width: 32px; height: 32px; border-radius: 8px; margin-right: 10px;
  font-size: 15px; color: white; vertical-align: middle;
}
.section-title-icon.purple { background: linear-gradient(135deg, var(--accent-purple), #7c3aed); }
.section-title-icon.blue { background: linear-gradient(135deg, var(--accent), var(--accent-hover)); }

.count-badge {
  background: var(--accent-glow);
  color: var(--accent);
  border: 1px solid rgba(79,143,255,0.25);
  padding: 4px 12px; border-radius: 12px;
  font-size: 12px; font-weight: 700;
}

/* ── Articles ── */
.article-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 12px; }
.article-item {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer; transition: all 0.25s ease;
  display: flex; gap: 14px; align-items: flex-start;
  position: relative; overflow: hidden;
}
.article-item:hover {
  border-color: var(--accent);
  background: var(--hover-bg);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15), 0 0 0 1px var(--accent-glow);
}
.article-thumbnail {
  width: 88px; height: 88px;
  border-radius: 10px; flex-shrink: 0;
  overflow: hidden;
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; font-weight: 700; color: white;
  background: linear-gradient(135deg, var(--accent), var(--accent-purple));
}
.article-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
.article-body { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 5px; }
.article-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 16px; font-weight: 700;
  margin: 0; line-height: 1.35; color: var(--text-primary);
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.article-meta {
  font-size: 12px; color: var(--text-secondary);
  display: flex; align-items: center; gap: 5px; flex-wrap: wrap;
}
.meta-dot { width: 3px; height: 3px; background: var(--text-muted); border-radius: 50%; flex-shrink: 0; }
.article-stats {
  display: flex; align-items: center; gap: 12px;
  font-size: 12px; color: var(--text-secondary); margin-top: 4px;
}
.stat-item { display: flex; align-items: center; gap: 4px; }
.stat-item.views i { color: var(--accent); }
.stat-item.likes i { color: var(--accent-red); }

/* ── Libraries ── */
.library-list { display: flex; flex-direction: column; }
.library-row {
  display: flex; align-items: center; gap: 14px;
  padding: 13px 0;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer; transition: all 0.2s ease;
}
.library-row:last-child { border-bottom: none; padding-bottom: 0; }
.library-row:first-child { padding-top: 0; }
.library-row:hover { opacity: 0.8; }
.library-row:hover .library-row-title { color: var(--accent-purple); }
.library-row-icon {
  width: 40px; height: 40px; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; color: white; flex-shrink: 0;
  box-shadow: 0 2px 8px var(--accent-purple-glow);
}
.library-row-body { flex: 1; min-width: 0; }
.library-row-title {
  font-size: 14px; font-weight: 600; color: var(--text-primary);
  margin: 0 0 2px 0;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  transition: color 0.2s ease;
}
.library-row-meta { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.library-row-count {
  font-size: 11px; color: var(--accent-purple); font-weight: 700;
  background: var(--accent-purple-glow);
  border: 1px solid rgba(168,85,247,0.2);
  padding: 3px 9px; border-radius: 10px; flex-shrink: 0;
}

/* ── Quote ── */
.quote-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 36px 32px;
  margin-bottom: 20px;
  text-align: center;
  position: relative; overflow: hidden;
}
.quote-section::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at center top, var(--accent-glow), transparent 60%);
  pointer-events: none;
}
.quote-icon {
  font-size: 36px; color: var(--accent); margin-bottom: 18px;
  display: block; opacity: 0.4;
}
.quote-text {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 18px; font-style: italic; line-height: 1.65;
  color: var(--text-primary); margin: 0 0 18px 0;
  position: relative;
}
.quote-author { font-size: 13px; color: var(--text-secondary); font-weight: 600; letter-spacing: 0.02em; }

/* ── Theme Toggle ── */
.theme-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 20px 28px;
  margin-bottom: 28px;
  display: flex; align-items: center; justify-content: space-between; gap: 16px;
}
.theme-section-title { font-size: 15px; font-weight: 600; margin: 0 0 3px 0; color: var(--text-primary); }
.theme-section-desc { font-size: 13px; color: var(--text-secondary); margin: 0; }
.theme-toggle-btn {
  width: 48px; height: 28px; border-radius: 14px;
  background: var(--bg-tertiary);
  border: 2px solid var(--border-bright);
  cursor: pointer; position: relative; transition: all 0.3s ease; flex-shrink: 0;
  display: flex; align-items: center; padding: 0 4px;
}
.theme-toggle-btn::after {
  content: '';
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--text-secondary);
  transition: all 0.3s ease; transform: translateX(0);
}
body.light-theme .theme-toggle-btn {
  background: var(--accent-glow); border-color: var(--accent);
}
body.light-theme .theme-toggle-btn::after {
  background: var(--accent); transform: translateX(20px);
}

/* ── Empty / Loading / Error ── */
.empty-state { text-align: center; padding: 36px 20px; color: var(--text-secondary); }
.empty-state-icon {
  width: 56px; height: 56px; margin: 0 auto 14px;
  background: var(--bg-tertiary); border: 1px solid var(--border-color);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; color: var(--text-muted);
}
.empty-state-title { font-size: 16px; font-weight: 600; margin: 0 0 6px 0; color: var(--text-primary); }
.empty-state-text { font-size: 13px; margin: 0; }
.loading-state { text-align: center; padding: 36px; color: var(--text-secondary); font-size: 15px; }
.error-state { text-align: center; padding: 36px; color: #f87171; font-size: 14px; }

/* ── Footer ── */
.footer-spacer { height: calc(72px + env(safe-area-inset-bottom)); }
.footer-bar {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 450px;
  background: var(--header-bg);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid var(--border-color);
  padding: 8px 24px;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  display: flex; justify-content: space-around; align-items: center;
  z-index: 100;
}
.footer-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  background: none; border: none;
  color: var(--text-muted);
  cursor: pointer; transition: color 0.2s ease;
  padding: 6px 12px; border-radius: 8px;
}
.footer-btn:hover { color: var(--text-secondary); }
.footer-btn.active { color: var(--accent); }
.footer-btn i { font-size: 19px; }
.footer-btn span { font-size: 10px; font-weight: 600; letter-spacing: 0.02em; }

/* ── Divider ── */
.section-divider {
  display: flex; align-items: center; gap: 12px;
  margin: 0 0 16px 0;
}
.section-divider-line { flex: 1; height: 1px; background: var(--border-color); }
.section-divider-label {
  font-size: 10px; font-weight: 700; letter-spacing: 0.08em;
  color: var(--text-muted); text-transform: uppercase;
}

@media (max-width: 768px) {
  .fab-create { bottom: 80px; right: 16px; }
  .list-container {
    padding: 14px 14px 0;
    padding-top: calc(57px + env(safe-area-inset-top) + 14px);
  }
  .stories-section { margin-bottom: 20px; }
  .stories-scroll { gap: 12px; padding: 4px 0 10px; }
  .story-avatar, .story-loading { width: 60px; height: 60px; }
  .story-avatar-content { font-size: 20px; }
  .story-username { font-size: 10px; max-width: 60px; }
  .home-hero { padding: 22px 20px; }
  .hero-title { font-size: 24px; }
  .hero-stats { gap: 6px; }
  .section-card { padding: 20px 18px; }
  .section-title { font-size: 17px; }
  .article-thumbnail { width: 76px; height: 76px; font-size: 24px; border-radius: 8px; }
  .article-title { font-size: 14px; }
  .library-row { gap: 12px; padding: 11px 0; }
  .library-row-icon { width: 36px; height: 36px; font-size: 13px; border-radius: 8px; }
  .quote-section { padding: 28px 20px; }
  .quote-text { font-size: 16px; }
  .theme-section { padding: 16px 20px; }
  .footer-bar { padding: 8px 16px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
  .footer-btn { padding: 5px 8px; }
  .footer-btn i { font-size: 17px; }
  .create-modal-content { max-width: 92%; }
  .header { padding: 12px 16px; }
}
</style>
</head>
<body>

<div class="header-wrapper">
  <div class="header">
    <img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo" onclick="window.location.href='index.html'">
    <div class="header-actions">
      <div class="auth-buttons" id="authButtons">
        <a href="login.html" class="btn-login">Log In</a>
      </div>
      <div class="user-welcome" id="userWelcome">
        <div class="welcome-pill" id="welcomeText">
          <i class="fas fa-user-circle"></i>
          <span id="welcomeLabel">Welcome</span>
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<button class="fab-create" id="fabCreateBtn" onclick="showCreateModal()" title="Create">
  <i class="fas fa-plus"></i>
</button>

<!-- Create Modal -->
<div class="create-modal" id="createModal">
  <div class="create-modal-content">
    <div class="create-modal-header">
      <h2 class="create-modal-title">Create New</h2>
      <button class="create-modal-close" onclick="closeCreateModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="create-modal-body">
      <div class="create-option" onclick="createArticle()">
        <div class="create-option-icon article"><i class="fas fa-file-alt"></i></div>
        <div class="create-option-content">
          <h3 class="create-option-title">Article</h3>
          <p class="create-option-desc">Write and publish a new article</p>
        </div>
      </div>
      <div class="create-option" onclick="createLibrary()">
        <div class="create-option-icon library"><i class="fas fa-bookmark"></i></div>
        <div class="create-option-content">
          <h3 class="create-option-title">Library</h3>
          <p class="create-option-desc">Create a curated collection of articles</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="list-container">

  <!-- Stories -->
  <div class="stories-section">
    <div class="stories-scroll" id="storiesScroll">
      <div class="loading-state" style="width:100%;padding:16px 0;">Loading profiles…</div>
    </div>
  </div>

  <!-- Hero -->
  <div class="home-hero">
    <h1 class="hero-title">Welcome to Patholytica</h1>
    <div class="hero-stats">
      <div class="hero-stat">
        <span class="hero-stat-value" id="totalArticles">0</span>
        <span class="hero-stat-label">articles</span>
      </div>
      <span class="hero-stat-sep">·</span>
      <div class="hero-stat">
        <span class="hero-stat-value" id="totalViews">0</span>
        <span class="hero-stat-label">views</span>
      </div>
      <span class="hero-stat-sep">·</span>
      <div class="hero-stat">
        <span class="hero-stat-value" id="totalLikes">0</span>
        <span class="hero-stat-label">likes</span>
      </div>
    </div>
    <p class="hero-description">Discover insightful articles from our community of writers and researchers.</p>
  </div>

  <!-- Libraries -->
  <div class="section-card">
    <div class="section-header">
      <h2 class="section-title">
        <span class="section-title-icon purple"><i class="fas fa-bookmark"></i></span>
        Featured Libraries
      </h2>
    </div>
    <div class="library-list" id="libraryList">
      <div class="loading-state" style="padding:20px 0;">Loading libraries…</div>
    </div>
  </div>

  <!-- Articles -->
  <div class="section-card">
    <div class="section-header">
      <h2 class="section-title">
        <span class="section-title-icon blue"><i class="fas fa-file-alt"></i></span>
        Recent Articles
      </h2>
      <span class="count-badge" id="articleCount">0</span>
    </div>
    <ul class="article-list" id="articleList">
      <li class="loading-state">Loading articles…</li>
    </ul>
  </div>

  <!-- Quote -->
  <div class="quote-section">
    <i class="fas fa-quote-left quote-icon"></i>
    <p class="quote-text" id="quoteText">Loading quote…</p>
    <p class="quote-author" id="quoteAuthor">— Astronaut</p>
  </div>

  <!-- Theme Toggle -->
  <div class="theme-section">
    <div>
      <h3 class="theme-section-title">Appearance</h3>
      <p class="theme-section-desc">Switch between light and dark mode</p>
    </div>
    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme" aria-label="Toggle theme"></button>
  </div>

  <div class="footer-spacer"></div>
</div>

<!-- Footer Nav -->
<div class="footer-bar">
  <button class="footer-btn active" onclick="window.location.href='index.html'">
    <i class="fas fa-home"></i><span>Home</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='https://patholytica.com/dailyfeed'">
    <i class="fas fa-scroll"></i><span>Feed</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='explore.html'">
    <i class="fas fa-search"></i><span>Explore</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='profile.html'">
    <i class="fas fa-user"></i><span>Profile</span>
  </button>
</div>

<script>
const astronautQuotes = [
  { text: "The Earth is the cradle of humanity, but mankind cannot stay in the cradle forever.", author: "Konstantin Tsiolkovsky" },
  { text: "That's one small step for man, one giant leap for mankind.", author: "Neil Armstrong" },
  { text: "The view of the Earth from the Moon fascinated me — a small disk, 240,000 miles away.", author: "Jim Lovell" },
  { text: "Space exploration is a force of nature unto itself that no other force in society can rival.", author: "Neil deGrasse Tyson" },
  { text: "To confine our attention to terrestrial matters would be to limit the human spirit.", author: "Stephen Hawking" },
  { text: "The Earth is a very small stage in a vast cosmic arena.", author: "Carl Sagan" },
  { text: "We choose to go to the Moon not because it is easy, but because it is hard.", author: "John F. Kennedy" },
  { text: "Houston, Tranquility Base here. The Eagle has landed.", author: "Neil Armstrong" },
  { text: "The stars don't look bigger, but they do look brighter.", author: "Sally Ride" },
  { text: "Space travel is life-enhancing, and anything that's life-enhancing is worth doing.", author: "Ray Bradbury" }
];
const randomQuote = astronautQuotes[Math.floor(Math.random() * astronautQuotes.length)];
document.getElementById('quoteText').textContent = randomQuote.text;
document.getElementById('quoteAuthor').textContent = `— ${randomQuote.author}`;

function toggleTheme() {
  document.body.classList.toggle('light-theme');
  localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
}
if (localStorage.getItem("theme") === "light") document.body.classList.add("light-theme");

function formatNumber(num) {
  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
  return num.toString();
}
function openArticle(id) { window.location.href = `article.html?id=${id}`; }
function openProfile(u) { window.location.href = `profile.html?username=${u}`; }
function openLibrary(id) { window.location.href = `playlist.html?id=${id}`; }
function showCreateModal() { document.getElementById('createModal').classList.add('show'); }
function closeCreateModal() { document.getElementById('createModal').classList.remove('show'); }
function createArticle() { window.location.href = 'https://patholytica.com/create'; }
function createLibrary() { window.location.href = 'https://patholytica.com/librarycreate'; }
document.getElementById('createModal').addEventListener('click', function(e) { if(e.target===this) closeCreateModal(); });

const USERNAME_CACHE_KEY = 'patholytica_username_cache';
const CACHE_DURATION = 24*60*60*1000;
function getCachedUsername(uid) {
  try {
    const d = JSON.parse(localStorage.getItem(USERNAME_CACHE_KEY));
    if (d && d.uid===uid && Date.now()-d.timestamp<CACHE_DURATION) return d.username;
  } catch(e) {}
  return null;
}
function setCachedUsername(uid, username) {
  try { localStorage.setItem(USERNAME_CACHE_KEY, JSON.stringify({uid, username, timestamp: Date.now()})); } catch(e) {}
}
function shuffleArray(arr) {
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
window.formatNumber=formatNumber; window.shuffleArray=shuffleArray;
window.getCachedUsername=getCachedUsername; window.setCachedUsername=setCachedUsername;
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const supabase = window.supabase.createClient(
  "https://vduqewqyvszfquntmark.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdXFld3F5dnN6ZnF1bnRtYXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MTg3MjgsImV4cCI6MjA4NTE5NDcyOH0.V2JellFmUGgYhKfW-D4CBdcBHyPztOlcgLCBdhnXj7c"
);

async function loadStories(currentUser) {
  const storiesScroll = document.getElementById('storiesScroll');
  try {
    const { data: articles } = await supabase.from('articles').select('firebase_user_id, views');
    if (!articles || articles.length === 0) {
      storiesScroll.innerHTML = `<div class="empty-state" style="width:100%"><div class="empty-state-icon"><i class="fas fa-users"></i></div><h3 class="empty-state-title">No profiles yet</h3></div>`;
      return;
    }
    const userViews = {};
    articles.forEach(a => { if(a.firebase_user_id) userViews[a.firebase_user_id] = (userViews[a.firebase_user_id]||0)+(a.views||0); });
    let topUsers = Object.entries(userViews).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([uid,views])=>({firebase_uid:uid,totalViews:views}));
    const { data: users } = await supabase.from('users').select('firebase_uid, username, pfp').in('firebase_uid', topUsers.map(u=>u.firebase_uid));
    if (!users) { storiesScroll.innerHTML = '<div class="error-state">Error loading profiles</div>'; return; }
    storiesScroll.innerHTML = '';
    if (currentUser) {
      const si = document.createElement('div');
      si.className = 'story-item current-user'; si.id = 'currentUserStory';
      si.innerHTML = `<div class="story-loading"></div><div class="story-username">You</div>`;
      storiesScroll.appendChild(si);
      topUsers = topUsers.filter(u=>u.firebase_uid!==currentUser.uid);
    }
    topUsers.forEach(topUser => {
      const user = users.find(u=>u.firebase_uid===topUser.firebase_uid);
      if (!user) return;
      const initial = user.username ? user.username[0].toUpperCase() : 'U';
      const si = document.createElement('div');
      si.className = 'story-item'; si.onclick = ()=>openProfile(user.username);
      const avatarHTML = user.pfp ? `<img src="${user.pfp}" alt="${user.username}" onerror="this.remove();this.parentElement.textContent='${initial}';">` : initial;
      si.innerHTML = `<div class="story-avatar"><div class="story-avatar-inner"><div class="story-avatar-content">${avatarHTML}</div></div></div><div class="story-username">${user.username||'Unknown'}</div>`;
      storiesScroll.appendChild(si);
    });
    if (currentUser) {
      const cud = users.find(u=>u.firebase_uid===currentUser.uid);
      if (cud) {
        const initial = cud.username ? cud.username[0].toUpperCase() : 'Y';
        const avatarHTML = cud.pfp ? `<img src="${cud.pfp}" alt="${cud.username}">` : initial;
        const el = document.getElementById('currentUserStory');
        if (el) {
          el.onclick = ()=>openProfile(cud.username);
          el.innerHTML = `<div class="story-avatar"><div class="story-avatar-inner"><div class="story-avatar-content">${avatarHTML}</div></div></div><div class="story-username">You</div>`;
        }
      }
    }
  } catch(err) {
    storiesScroll.innerHTML = '<div class="error-state">Error loading profiles</div>';
  }
}

async function loadArticles() {
  const articleList = document.getElementById('articleList');
  try {
    const { data: allArticles, error } = await supabase.from('articles').select('id, title, created_at, views, likes, firebase_user_id, media(url)').order('created_at', { ascending: false });
    if (error) { articleList.innerHTML = '<li class="error-state">Error loading articles</li>'; return; }
    if (!allArticles || allArticles.length === 0) {
      articleList.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-file-alt"></i></div><h3 class="empty-state-title">No articles yet</h3><p class="empty-state-text">Be the first to publish</p></div>`;
      ['articleCount','totalArticles','totalViews','totalLikes'].forEach(id=>document.getElementById(id).textContent='0');
      return;
    }
    const totalViews = allArticles.reduce((s,a)=>s+(a.views||0),0);
    const totalLikes = allArticles.reduce((s,a)=>s+(a.likes||0),0);
    document.getElementById('totalArticles').textContent = formatNumber(allArticles.length);
    document.getElementById('totalViews').textContent = formatNumber(totalViews);
    document.getElementById('totalLikes').textContent = formatNumber(totalLikes);
    const articles = shuffleArray(allArticles).slice(0,8);
    const firebaseUserIds = [...new Set(articles.map(a=>a.firebase_user_id).filter(Boolean))];
    const { data: users } = await supabase.from('users').select('firebase_uid, username').in('firebase_uid', firebaseUserIds);
    const userMap = {};
    if (users) users.forEach(u=>{ userMap[u.firebase_uid]=u; });
    articleList.innerHTML = '';
    articles.forEach(article => {
      const li = document.createElement('li');
      li.className = 'article-item'; li.onclick = ()=>openArticle(article.id);
      const user = userMap[article.firebase_user_id];
      const authorName = user?.username ? `@${user.username}` : 'Unknown';
      const date = new Date(article.created_at);
      const diff = Date.now()-date;
      const mins = Math.floor(diff/60000), hrs = Math.floor(diff/3600000), days = Math.floor(diff/86400000);
      const formattedDate = mins<60?`${mins}m ago`:hrs<24?`${hrs}h ago`:days<7?`${days}d ago`:date.toLocaleDateString('en-US',{month:'short',day:'numeric'});
      const firstLetter = (article.title||'A')[0].toUpperCase();
      const articleImage = article.media&&article.media.length>0?article.media[0].url:null;
      const thumb = document.createElement('div');
      thumb.className = 'article-thumbnail';
      if (articleImage) {
        const img = document.createElement('img');
        img.src = articleImage; img.alt = article.title||'Article';
        img.onerror = ()=>{ img.remove(); thumb.textContent=firstLetter; };
        thumb.appendChild(img);
      } else { thumb.textContent = firstLetter; }
      const body = document.createElement('div');
      body.className = 'article-body';
      body.innerHTML = `<h2 class="article-title">${article.title||'Untitled'}</h2><div class="article-meta"><span>${authorName}</span><div class="meta-dot"></div><span>${formattedDate}</span></div><div class="article-stats"><div class="stat-item views"><i class="fas fa-eye"></i><span>${formatNumber(article.views||0)}</span></div><div class="stat-item likes"><i class="fas fa-heart"></i><span>${formatNumber(article.likes||0)}</span></div></div>`;
      li.appendChild(thumb); li.appendChild(body); articleList.appendChild(li);
    });
    document.getElementById('articleCount').textContent = articles.length;
  } catch(err) {
    articleList.innerHTML = '<li class="error-state">An unexpected error occurred</li>';
  }
}

async function loadLibraries() {
  const libraryList = document.getElementById('libraryList');
  try {
    const { data: libraries, error } = await supabase.from('playlists').select('*').order('created_at',{ascending:false}).limit(10);
    if (error || !libraries || libraries.length===0) {
      libraryList.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-bookmark"></i></div><h3 class="empty-state-title">No libraries yet</h3><p class="empty-state-text">Create the first library</p></div>`;
      return;
    }
    libraryList.innerHTML = '';
    libraries.forEach(library => {
      const count = library.article_count||0;
      const row = document.createElement('div');
      row.className = 'library-row'; row.onclick = ()=>openLibrary(library.id);
      row.innerHTML = `<div class="library-row-icon"><i class="fas fa-bookmark"></i></div><div class="library-row-body"><div class="library-row-title">${library.name||'Untitled Library'}</div><div class="library-row-meta">${library.description||'No description'}</div></div><div class="library-row-count">${count} articles</div>`;
      libraryList.appendChild(row);
    });
  } catch(err) {
    libraryList.innerHTML = '<div class="error-state">Error loading libraries</div>';
  }
}

window.logOut = async function() {
  try { await signOut(auth); localStorage.removeItem('patholytica_username_cache'); window.location.reload(); }
  catch(e) { alert("Error logging out. Please try again."); }
};

onAuthStateChanged(auth, async (user) => {
  const authButtons = document.getElementById('authButtons');
  const userWelcome = document.getElementById('userWelcome');
  const welcomeText = document.getElementById('welcomeText');
  const welcomeLabel = document.getElementById('welcomeLabel');
  const fabCreateBtn = document.getElementById('fabCreateBtn');

  if (user) {
    authButtons.classList.remove('show');
    userWelcome.classList.add('show');
    if (fabCreateBtn) fabCreateBtn.classList.add('show');
    welcomeText.onclick = window.logOut;
    const cached = getCachedUsername(user.uid);
    if (cached) welcomeLabel.textContent = `@${cached}`;
    try {
      const { data: ud } = await supabase.from('users').select('username').eq('firebase_uid', user.uid).single();
      if (ud?.username) { welcomeLabel.textContent = `@${ud.username}`; setCachedUsername(user.uid, ud.username); }
    } catch(e) {}
  } else {
    authButtons.classList.add('show');
    userWelcome.classList.remove('show');
    if (fabCreateBtn) fabCreateBtn.classList.remove('show');
  }

  loadStories(user);
  loadArticles();
  loadLibraries();
});
</script>
</body>
</html>