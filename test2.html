<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Patholytica — Create Article</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #1f1f1f;
            --text-primary: #fff;
            --text-secondary: #aaa;
            --card-bg: #1f1f1f;
            --hover-bg: #2a2a2a;
            --border-color: #303030;
            --accent: #3ea6ff;
            --accent-hover: #2d8ed6;
            --success: #2ecc71;
            --error: #e74c3c;
        }

        body.light-theme {
            --bg-color: #f9f9f9;
            --text-primary: #0f0f0f;
            --text-secondary: #606060;
            --card-bg: #f9f9f9;
            --hover-bg: #f0f0f0;
            --border-color: #e5e5e5;
            --accent: #065fd4;
            --accent-hover: #0448a3;
            --success: #27ae60;
            --error: #c0392b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            transition: background 0.2s ease, color 0.2s ease;
        }

        .app-container {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 450px;
            height: 100vh;
            background: var(--bg-color);
            overflow-y: auto;
        }

        .app-container::-webkit-scrollbar { width: 4px; }
        .app-container::-webkit-scrollbar-track { background: var(--border-color); }
        .app-container::-webkit-scrollbar-thumb { background: var(--text-secondary); border-radius: 2px; }

        .header-bar {
            position: sticky;
            top: 0;
            background: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 50;
        }

        .back-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            transition: background 0.2s ease;
        }
        .back-btn:hover { background: var(--border-color); }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .icon-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            transition: background 0.2s ease;
        }
        .icon-btn:hover { background: var(--border-color); }

        .icon-btn.bolt-btn {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            box-shadow: 0 2px 8px rgba(245,158,11,0.4);
            transition: all 0.2s ease;
        }
        .icon-btn.bolt-btn:hover {
            background: linear-gradient(135deg, #d97706, #dc2626);
            box-shadow: 0 4px 16px rgba(245,158,11,0.5);
            transform: scale(1.08);
        }
        .icon-btn.bolt-btn.loading {
            animation: boltPulse 0.8s ease-in-out infinite;
            cursor: not-allowed;
        }
        @keyframes boltPulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(245,158,11,0.4); transform: scale(1); }
            50% { box-shadow: 0 4px 20px rgba(245,158,11,0.8); transform: scale(1.1); }
        }

        .publish-btn {
            padding: 8px 20px;
            border-radius: 24px;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .publish-btn:hover { background: var(--accent-hover); }
        .publish-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .editor-wrapper {
            padding: 20px;
            padding-bottom: 100px;
        }

        .article-title-input {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.2;
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
            resize: none;
            overflow: hidden;
            padding: 0;
            font-family: inherit;
        }
        .article-title-input::placeholder { color: var(--text-secondary); opacity: 0.5; }

        .content-item { margin-bottom: 14px; }

        .content-line {
            font-size: 16px;
            line-height: 1.6;
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .content-editable {
            outline: none;
            min-height: 1.6em;
            word-wrap: break-word;
            overflow-wrap: break-word;
            flex: 1;
            cursor: text;
            color: var(--text-primary);
        }
        .content-editable:empty::before {
            content: 'Start writing...';
            color: var(--text-secondary);
            opacity: 0.5;
        }
        .content-editable:focus {
            background: var(--hover-bg);
            padding: 4px 8px;
            margin: -4px -8px;
            border-radius: 4px;
        }

        .line-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s ease; }
        .content-line:hover .line-actions { opacity: 1; }

        .line-btn {
            width: 28px; height: 28px; min-width: 28px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .line-btn:hover { background: var(--border-color); color: var(--accent); }

        .media-embed { margin: 16px 0; max-width: 100%; position: relative; }
        .media-embed img { width: 100%; max-width: 100%; height: auto; border-radius: 8px; display: block; }
        .media-caption { font-size: 13px; color: var(--text-secondary); margin-top: 6px; font-style: italic; outline: none; cursor: text; }
        .media-caption:empty::before { content: 'Add a caption...'; opacity: 0.5; }

        .remove-media-btn {
            position: absolute; top: 8px; right: 8px;
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            color: white; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease; z-index: 10;
        }
        .media-embed:hover .remove-media-btn { opacity: 1; }
        .remove-media-btn:hover { background: var(--error); }

        .custom-audio-player {
            background: var(--card-bg);
            border-radius: 12px; padding: 16px;
            display: flex; align-items: center; gap: 12px;
            max-width: 100%;
            border: 1px solid var(--border-color);
        }

        .play-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--accent); border: none; color: white;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: all 0.2s ease; flex-shrink: 0;
        }
        .play-btn:hover { background: var(--accent-hover); transform: scale(1.05); }

        .audio-info { flex: 1; min-width: 0; overflow: hidden; }
        .audio-title { font-size: 13px; font-weight: 500; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }

        .waveform-container {
            position: relative; height: 32px;
            background: var(--hover-bg); border-radius: 4px; margin-bottom: 6px;
            cursor: pointer; overflow: hidden;
        }
        .waveform-progress { position: absolute; top: 0; left: 0; height: 100%; background: var(--accent); opacity: 0.3; transition: width 0.1s linear; }
        .waveform-bars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-around; padding: 0 4px; }
        .waveform-bar { width: 2px; background: var(--text-secondary); border-radius: 2px; opacity: 0.6; }
        .audio-time { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); }

        .action-bar {
            position: fixed; bottom: 0;
            left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 450px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 12px 20px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
            display: flex; gap: 12px; z-index: 100;
        }

        .action-btn {
            flex: 1;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px; font-weight: 600; color: var(--text-primary);
        }
        .action-btn:active { transform: scale(0.95); }
        .action-btn svg { width: 20px; height: 20px; stroke: var(--text-primary); fill: none; stroke-width: 2; }

        .divider { width: 1px; height: 24px; background: var(--border-color); margin: 0; }

        /* Toast notification */
        .notification {
            position: fixed; top: 70px;
            left: 50%; transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px; padding: 14px 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none; align-items: center; gap: 12px;
            min-width: 260px; max-width: 400px;
        }
        .notification.show { display: flex; animation: slideDown 0.3s ease; }
        .notification.success { border-left: 4px solid var(--success); }
        .notification.error { border-left: 4px solid var(--error); }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-80px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .editor-wrapper { padding: 16px; }
            .article-title-input { font-size: 26px; }
            .notification { left: 16px; right: 16px; transform: none; min-width: auto; max-width: none; }
            .notification.show { animation: slideDownMobile 0.3s ease; }
            @keyframes slideDownMobile {
                from { transform: translateY(-80px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        }
    </style>
</head>
<body>

<div class="app-container" id="appContainer">
    <div class="header-bar">
        <button class="back-btn" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-actions">
            <button class="icon-btn bolt-btn" id="boltBtn" onclick="generateTrendingArticle()" title="Generate Trending Article">
                <i class="fas fa-bolt"></i>
            </button>
            <button class="icon-btn" onclick="toggleTheme()" title="Toggle theme">
                <i class="fas fa-circle-half-stroke"></i>
            </button>
            <button class="publish-btn" id="publishBtn" onclick="publishArticle()">Publish</button>
        </div>
    </div>

    <div class="editor-wrapper" id="editorContainer">
        <textarea class="article-title-input" id="articleTitle" placeholder="Article Title" rows="1" oninput="autoResizeTitle(this)"></textarea>

        <div id="contentItems">
            <div class="content-item">
                <div class="content-line" data-line="1">
                    <div class="content-editable" contenteditable="true"></div>
                    <div class="line-actions">
                        <button class="line-btn" onclick="deleteLine(this)" title="Delete line">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="action-bar">
    <button class="action-btn" onclick="addNewParagraph()" title="Add text">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        <span>Text</span>
    </button>
    <div class="divider"></div>
    <label class="action-btn" title="Upload image">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        <span>Image</span>
        <input type="file" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">
    </label>
    <label class="action-btn" title="Upload audio">
        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        <span>Audio</span>
        <input type="file" accept="audio/*" onchange="handleAudioUpload(event)" style="display: none;">
    </label>
</div>

<div class="notification" id="notification">
    <i class="fas fa-check-circle" style="font-size: 20px;"></i>
    <span id="notificationText"></span>
</div>

<script>
let lineCounter = 1;

function goBack() {
    if (document.referrer && document.referrer.includes(window.location.host)) {
        window.history.back();
    } else {
        window.location.href = 'index.html';
    }
}

function toggleTheme() {
    document.body.classList.toggle('light-theme');
    localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
}

if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light-theme");
}

function autoResizeTitle(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

// ⚡ Generate Trending Article from Google News RSS
async function generateTrendingArticle() {
    const btn = document.getElementById('boltBtn');
    btn.classList.add('loading');
    btn.disabled = true;

    showNotification("Fetching trending news...", "success");

    try {
        const response = await fetch(
            "https://api.allorigins.win/get?url=" +
            encodeURIComponent("https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en")
        );

        if (!response.ok) throw new Error("Network error");

        const data = await response.json();
        const parser = new DOMParser();
        const xml = parser.parseFromString(data.contents, "text/xml");
        const items = xml.querySelectorAll("item");

        if (!items.length) {
            showNotification("No news found. Try again.", "error");
            return;
        }

        // Pick a random trending item
        const randomItem = items[Math.floor(Math.random() * Math.min(items.length, 20))];

        const rawTitle = randomItem.querySelector("title")?.textContent || "Trending Now";
        const rawDesc  = randomItem.querySelector("description")?.textContent || "";
        const pubDate  = randomItem.querySelector("pubDate")?.textContent || "";
        const source   = randomItem.querySelector("source")?.textContent || "News";

        // Strip any HTML tags from description
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = rawDesc;
        const cleanDesc = tempDiv.textContent || tempDiv.innerText || "";

        // Clean title — remove " - Source" suffix Google News appends
        const cleanTitle = rawTitle.replace(/\s*-\s*[^-]+$/, "").trim();

        // Format publish date nicely
        const formattedDate = pubDate
            ? new Date(pubDate).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" })
            : "";

        // Build expanded article paragraphs
        const paragraphs = [
            cleanDesc || "Details on this breaking story are still emerging.",
            `Reported by ${source}${formattedDate ? " on " + formattedDate : ""}, this story has quickly gained traction across major news platforms and social media.`,
            "Analysts and experts are closely watching developments, with many anticipating significant implications for the industry, region, or communities involved.",
            "Public reaction has been swift, with stakeholders from various sectors weighing in on the potential short- and long-term impact of these events.",
            "Further updates are expected as the situation continues to evolve. Stay tuned to Patholytica for in-depth coverage and expert analysis."
        ];

        // Set title
        const titleInput = document.getElementById("articleTitle");
        titleInput.value = cleanTitle;
        autoResizeTitle(titleInput);

        // Clear old content
        document.getElementById("contentItems").innerHTML = "";
        lineCounter = 0;

        // Insert paragraphs
        paragraphs.forEach(text => {
            if (!text.trim()) return;
            lineCounter++;
            const contentItem = document.createElement("div");
            contentItem.className = "content-item";
            contentItem.innerHTML = `
                <div class="content-line" data-line="${lineCounter}">
                    <div class="content-editable" contenteditable="true">${text}</div>
                    <div class="line-actions">
                        <button class="line-btn" onclick="deleteLine(this)" title="Delete line">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById("contentItems").appendChild(contentItem);
        });

        document.getElementById("appContainer").scrollTo({ top: 0, behavior: "smooth" });
        showNotification("Trending article generated! ⚡", "success");

    } catch (error) {
        console.error(error);
        showNotification("Failed to fetch news. Check your connection.", "error");
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

function addNewParagraph() {
    lineCounter++;
    const contentItem = document.createElement('div');
    contentItem.className = 'content-item';
    contentItem.innerHTML = `
        <div class="content-line" data-line="${lineCounter}">
            <div class="content-editable" contenteditable="true"></div>
            <div class="line-actions">
                <button class="line-btn" onclick="deleteLine(this)" title="Delete line">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    document.getElementById('contentItems').appendChild(contentItem);
    contentItem.querySelector('.content-editable').focus();
}

function deleteLine(btn) {
    const contentItem = btn.closest('.content-item');
    const allItems = document.querySelectorAll('.content-item .content-line');
    if (allItems.length > 1) {
        contentItem.remove();
    } else {
        showNotification('Cannot delete the last line', 'error');
    }
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const contentItem = document.createElement('div');
        contentItem.className = 'content-item';
        contentItem.innerHTML = `
            <div class="media-embed">
                <button class="remove-media-btn" onclick="removeMedia(this)"><i class="fas fa-times"></i></button>
                <img src="${e.target.result}" alt="Uploaded image">
                <div class="media-caption" contenteditable="true"></div>
            </div>
        `;
        document.getElementById('contentItems').appendChild(contentItem);
    };
    reader.readAsDataURL(file);
    event.target.value = '';
}

function handleAudioUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const audioId = 'audio-' + Math.random().toString(36).substr(2, 9);
        const contentItem = document.createElement('div');
        contentItem.className = 'content-item';
        contentItem.innerHTML = `
            <div class="media-embed">
                <button class="remove-media-btn" onclick="removeMedia(this)"><i class="fas fa-times"></i></button>
                <div class="custom-audio-player">
                    <button class="play-btn" onclick="toggleAudio(this, '${audioId}')"><i class="fas fa-play"></i></button>
                    <div class="audio-info">
                        <div class="audio-title">${file.name}</div>
                        <div class="waveform-container" onclick="seekAudio(event, this, '${audioId}')">
                            <div class="waveform-progress"></div>
                            <div class="waveform-bars">${Array(15).fill(0).map(() => `<div class="waveform-bar" style="height:${Math.random()*60+20}%"></div>`).join('')}</div>
                        </div>
                        <div class="audio-time"><span class="current-time">0:00</span><span class="duration">0:00</span></div>
                    </div>
                    <audio id="${audioId}" src="${e.target.result}" style="display:none;"></audio>
                </div>
                <div class="media-caption" contenteditable="true"></div>
            </div>
        `;
        document.getElementById('contentItems').appendChild(contentItem);
        setTimeout(() => {
            const audio = document.getElementById(audioId);
            if (audio) {
                audio.addEventListener('loadedmetadata', function() {
                    const d = Math.floor(audio.duration);
                    const m = Math.floor(d/60), s = d%60;
                    const span = audio.closest('.custom-audio-player').querySelector('.duration');
                    if (span) span.textContent = `${m}:${s.toString().padStart(2,'0')}`;
                });
            }
        }, 100);
    };
    reader.readAsDataURL(file);
    event.target.value = '';
}

function removeMedia(btn) { btn.closest('.content-item').remove(); }

function toggleAudio(btn, audioId) {
    const player = btn.closest('.custom-audio-player');
    const audio = document.getElementById(audioId);
    const icon = btn.querySelector('i');
    if (audio.paused) {
        audio.play(); icon.className = 'fas fa-pause';
        audio.ontimeupdate = function() {
            const p = (audio.currentTime / audio.duration) * 100;
            player.querySelector('.waveform-progress').style.width = p + '%';
            const cm = Math.floor(audio.currentTime / 60), cs = Math.floor(audio.currentTime % 60);
            player.querySelector('.current-time').textContent = `${cm}:${cs.toString().padStart(2,'0')}`;
        };
        audio.onended = function() {
            icon.className = 'fas fa-play';
            player.querySelector('.waveform-progress').style.width = '0%';
            player.querySelector('.current-time').textContent = '0:00';
        };
    } else {
        audio.pause(); icon.className = 'fas fa-play';
    }
}

function seekAudio(event, container, audioId) {
    const audio = document.getElementById(audioId);
    const rect = container.getBoundingClientRect();
    audio.currentTime = ((event.clientX - rect.left) / rect.width) * audio.duration;
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    const icon = notification.querySelector('i');
    notificationText.textContent = message;
    notification.className = `notification ${type} show`;
    icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    icon.style.color = type === 'success' ? 'var(--success)' : 'var(--error)';
    setTimeout(() => notification.classList.remove('show'), 4000);
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
    authDomain: "patholytica.firebaseapp.com",
    databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "patholytica",
    storageBucket: "patholytica.firebasestorage.app",
    messagingSenderId: "738430635282",
    appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
let currentUser = null;

const supabase = window.supabase.createClient(
    "https://vduqewqyvszfquntmark.supabase.co",
    "sb_publishable_YseP73aoHam8YT6B0b9EQQ_iAUEWARI"
);

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
    } else {
        window.location.href = 'login.html';
    }
});

window.publishArticle = async function() {
    if (!currentUser) { showNotification('Please log in to publish articles', 'error'); return; }

    const title = document.getElementById('articleTitle').value.trim();
    if (!title) { showNotification('Please add a title', 'error'); return; }

    const contentLines = [];
    const mediaItems = [];

    document.querySelectorAll('.content-line').forEach(line => {
        const text = line.querySelector('.content-editable').textContent.trim();
        if (text) contentLines.push(text);
    });

    document.querySelectorAll('.media-embed').forEach((media, index) => {
        const img = media.querySelector('img');
        const audio = media.querySelector('audio');
        const caption = media.querySelector('.media-caption')?.textContent.trim() || '';
        if (img) mediaItems.push({ type: 'image', src: img.src, caption, order: index });
        else if (audio) mediaItems.push({ type: 'audio', src: audio.src, caption, order: index });
    });

    const content = contentLines.join('\n\n');
    if (!content) { showNotification('Please add some content', 'error'); return; }

    const publishBtn = document.getElementById('publishBtn');
    publishBtn.disabled = true;
    publishBtn.textContent = 'Publishing...';

    try {
        let { data: userData, error: userError } = await supabase
            .from('users').select('firebase_uid').eq('firebase_uid', currentUser.uid).single();

        if (userError && userError.code !== 'PGRST116') throw new Error('Error looking up user: ' + userError.message);

        if (!userData) {
            let { data: emailUser } = await supabase.from('users').select('firebase_uid, username, email').eq('email', currentUser.email).single();
            if (emailUser) {
                await supabase.from('users').update({ firebase_uid: currentUser.uid, username: emailUser.username || currentUser.email?.split('@')[0], full_name: currentUser.displayName || currentUser.email?.split('@')[0] }).eq('email', currentUser.email);
            } else {
                await supabase.from('users').insert([{ firebase_uid: currentUser.uid, email: currentUser.email, full_name: currentUser.displayName || currentUser.email?.split('@')[0], username: currentUser.email?.split('@')[0] || 'user' }]);
            }
        }

        const { data: article, error: articleError } = await supabase
            .from('articles')
            .insert([{ title, content, firebase_user_id: currentUser.uid, views: 0, likes: 0 }])
            .select().single();

        if (articleError) throw articleError;

        if (mediaItems.length > 0) {
            await supabase.from('media').insert(mediaItems.map(item => ({ article_id: article.id, type: item.type, url: item.src, caption: item.caption, display_order: item.order })));
        }

        showNotification('Article published successfully!', 'success');
        setTimeout(() => { window.location.href = `article.html?id=${article.id}`; }, 1500);

    } catch (error) {
        console.error('Error publishing article:', error);
        showNotification('Error publishing: ' + error.message, 'error');
        publishBtn.disabled = false;
        publishBtn.textContent = 'Publish';
    }
};
</script>

</body>
</html>