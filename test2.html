<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica — Library</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0a0a0e;
  --bg-2: #111118;
  --bg-3: #18181f;
  --bg-4: #1f1f28;
  --surface: #16161e;
  --surface-2: #1e1e28;
  --surface-3: #26262f;
  --border: rgba(255,255,255,0.07);
  --border-2: rgba(255,255,255,0.12);
  --text-1: #f2f2f8;
  --text-2: #9090a8;
  --text-3: #55556a;
  --accent: #7c6dfa;
  --accent-2: #a855f7;
  --accent-3: #ec4899;
  --accent-green: #22d3a5;
  --accent-blue: #38bdf8;
  --grad-main: linear-gradient(135deg, #7c6dfa 0%, #a855f7 50%, #ec4899 100%);
  --grad-green: linear-gradient(135deg, #22d3a5, #0ea5e9);
  --grad-purple: linear-gradient(135deg, #7c6dfa, #a855f7);
  --grad-warm: linear-gradient(135deg, #f97316, #ec4899);
  --glow-accent: rgba(124,109,250,0.2);
  --glow-pink: rgba(236,72,153,0.15);
  --glow-green: rgba(34,211,165,0.15);
}

body.light-theme {
  --bg: #f0eff8;
  --bg-2: #e8e7f4;
  --bg-3: #ffffff;
  --bg-4: #f8f7ff;
  --surface: #ffffff;
  --surface-2: #f4f3ff;
  --surface-3: #ece9ff;
  --border: rgba(0,0,0,0.07);
  --border-2: rgba(0,0,0,0.12);
  --text-1: #0f0e1a;
  --text-2: #5a5870;
  --text-3: #9896b0;
  --glow-accent: rgba(124,109,250,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
  min-height: 100%; font-family: 'Inter', sans-serif;
  overflow-x: hidden; max-width: 100vw;
}
body {
  background: var(--bg);
  color: var(--text-1);
  transition: background 0.3s, color 0.3s;
}

/* ─── Noise texture overlay ─── */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0; opacity: 0.4;
}

/* ─── Ambient glows ─── */
.ambient {
  position: fixed; pointer-events: none; z-index: 0; border-radius: 50%;
  filter: blur(80px); opacity: 0.12;
}
.ambient-1 { width: 500px; height: 500px; top: -150px; right: -100px; background: var(--accent); }
.ambient-2 { width: 400px; height: 400px; bottom: 100px; left: -150px; background: var(--accent-3); opacity: 0.08; }

/* ─── Header ─── */
.header-wrapper {
  position: fixed; top: 0; left: 0; right: 0;
  z-index: 100;
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border);
  background: rgba(10,10,14,0.75);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
}
body.light-theme .header-wrapper { background: rgba(240,239,248,0.8); }

.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 13px 24px;
  max-width: 960px; margin: 0 auto;
}
.logo-wrap { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.logo-img { height: 26px; width: auto; transition: opacity 0.2s; }
.logo-img:hover { opacity: 0.7; }
body.light-theme .logo-img { filter: invert(1); }

.header-right { display: flex; align-items: center; gap: 10px; }

.auth-buttons { display: none; gap: 8px; }
.auth-buttons.show { display: flex; }
.btn-login {
  padding: 8px 18px; border-radius: 100px;
  font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
  text-decoration: none;
  border: 1px solid var(--border-2);
  background: var(--surface-2);
  color: var(--text-1);
}
.btn-login:hover { background: var(--surface-3); border-color: var(--accent); }

.user-welcome { display: none; align-items: center; }
.user-welcome.show { display: flex; }
.user-chip {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px 6px 8px;
  background: var(--surface-2);
  border: 1px solid var(--border-2);
  border-radius: 100px;
  cursor: pointer; transition: all 0.2s;
}
.user-chip:hover { border-color: var(--accent); background: var(--glow-accent); }
.user-chip-avatar {
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--grad-main); display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: white;
}
.user-chip-name { font-size: 13px; font-weight: 600; color: var(--accent); }

/* ─── FAB ─── */
.fab-create {
  position: fixed; bottom: 88px; right: 20px;
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--grad-main);
  color: white; border: none; cursor: pointer;
  display: none; align-items: center; justify-content: center;
  font-size: 20px;
  box-shadow: 0 4px 24px var(--glow-accent), 0 0 0 1px rgba(124,109,250,0.3);
  transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  z-index: 50;
}
.fab-create.show { display: flex; }
.fab-create:hover { transform: scale(1.1) rotate(45deg); box-shadow: 0 8px 32px rgba(124,109,250,0.5); }
.fab-create:active { transform: scale(0.95) rotate(45deg); }

/* ─── Modal ─── */
.create-modal {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
  z-index: 1000; align-items: center; justify-content: center; padding: 20px;
}
.create-modal.show { display: flex; }
.create-modal-content {
  background: var(--bg-3);
  border: 1px solid var(--border-2);
  border-radius: 24px; width: 100%; max-width: 380px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px var(--border);
  overflow: hidden;
}
.create-modal-header {
  padding: 22px 24px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.create-modal-title { font-size: 18px; font-weight: 700; color: var(--text-1); }
.create-modal-close {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--surface-3); border: 1px solid var(--border);
  color: var(--text-2); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; transition: all 0.2s;
}
.create-modal-close:hover { color: var(--text-1); transform: rotate(90deg); }
.create-modal-body { padding: 16px 20px 20px; display: flex; flex-direction: column; gap: 10px; }
.create-option {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 16px; border-radius: 14px;
  background: var(--surface-2); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.25s;
}
.create-option:hover { border-color: var(--accent); background: var(--glow-accent); transform: translateX(4px); }
.create-option-icon {
  width: 42px; height: 42px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; color: white; flex-shrink: 0;
}
.create-option-icon.article { background: var(--grad-green); }
.create-option-icon.library { background: var(--grad-purple); }
.create-option-title { font-size: 15px; font-weight: 600; color: var(--text-1); margin-bottom: 2px; }
.create-option-desc { font-size: 12px; color: var(--text-2); }

/* ─── Layout ─── */
.page {
  max-width: 960px; margin: 0 auto;
  padding: calc(57px + env(safe-area-inset-top) + 20px) 20px 0;
  position: relative; z-index: 1;
}

/* ─── Stories ─── */
.stories-wrap { margin-bottom: 24px; }
.stories-scroll {
  display: flex; gap: 12px;
  overflow-x: auto; padding: 4px 0 12px;
  scrollbar-width: none; -ms-overflow-style: none;
}
.stories-scroll::-webkit-scrollbar { display: none; }
.story-item {
  display: flex; flex-direction: column; align-items: center;
  gap: 7px; cursor: pointer; flex-shrink: 0; transition: transform 0.2s;
}
.story-item:hover { transform: scale(1.06); }
.story-ring {
  width: 66px; height: 66px; border-radius: 50%;
  background: var(--grad-main); padding: 2px;
  display: flex; align-items: center; justify-content: center;
}
.story-ring.green { background: var(--grad-green); }
.story-ring-inner {
  width: 100%; height: 100%; border-radius: 50%;
  background: var(--bg); padding: 2px;
  display: flex; align-items: center; justify-content: center; overflow: hidden;
}
.story-avatar-content {
  width: 100%; height: 100%; border-radius: 50%;
  background: var(--surface-3);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 800; color: var(--accent); overflow: hidden;
}
.story-avatar-content img { width: 100%; height: 100%; object-fit: cover; }
.story-label { font-size: 11px; font-weight: 500; color: var(--text-2); max-width: 66px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
.story-spin {
  width: 66px; height: 66px; border-radius: 50%;
  border: 2px solid var(--border);
  border-top: 2px solid var(--accent-green);
  animation: spin 0.9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ─── Hero Banner ─── */
.hero {
  border-radius: 24px; overflow: hidden;
  position: relative; margin-bottom: 20px;
  background: var(--surface);
  border: 1px solid var(--border-2);
  padding: 36px 36px 32px;
}
.hero-glow {
  position: absolute; inset: 0; pointer-events: none;
  background: radial-gradient(ellipse at top right, rgba(124,109,250,0.18), transparent 60%),
              radial-gradient(ellipse at bottom left, rgba(236,72,153,0.1), transparent 50%);
}
.hero-tag {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--glow-accent); border: 1px solid rgba(124,109,250,0.3);
  color: var(--accent); border-radius: 100px;
  padding: 4px 12px; font-size: 11px; font-weight: 700;
  letter-spacing: 0.06em; text-transform: uppercase;
  margin-bottom: 14px;
}
.hero-tag-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.5;transform:scale(1.3);} }
.hero-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 32px; font-weight: 700; line-height: 1.2;
  color: var(--text-1); margin-bottom: 18px;
}
.hero-stats { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.stat-pill {
  display: flex; align-items: center; gap: 7px;
  padding: 7px 14px;
  background: var(--surface-2); border: 1px solid var(--border);
  border-radius: 100px; font-size: 13px; color: var(--text-2);
}
.stat-pill-val { font-size: 14px; font-weight: 700; color: var(--text-1); }
.stat-pill i { font-size: 11px; }
.stat-pill.views i { color: var(--accent-blue); }
.stat-pill.articles i { color: var(--accent); }
.stat-pill.likes i { color: var(--accent-3); }
.hero-desc { font-size: 14px; color: var(--text-2); line-height: 1.65; }

/* ─── Two-column grid for wide screens ─── */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
@media (max-width: 680px) { .grid-2 { grid-template-columns: 1fr; } }

/* ─── Cards ─── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  position: relative; overflow: hidden;
}
.card-full { margin-bottom: 20px; }
.card-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 22px 0;
}
.card-title {
  display: flex; align-items: center; gap: 10px;
  font-size: 15px; font-weight: 700; color: var(--text-1);
}
.card-title-icon {
  width: 30px; height: 30px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; color: white;
}
.card-title-icon.purple { background: var(--grad-purple); }
.card-title-icon.blue { background: linear-gradient(135deg, var(--accent-blue), var(--accent)); }
.card-title-icon.green { background: var(--grad-green); }

.count-tag {
  font-size: 11px; font-weight: 700;
  padding: 4px 10px; border-radius: 100px;
  background: var(--glow-accent); color: var(--accent);
  border: 1px solid rgba(124,109,250,0.25);
}
.count-tag.purple { background: rgba(168,85,247,0.12); color: var(--accent-2); border-color: rgba(168,85,247,0.25); }

/* ─── Article list ─── */
.article-list { list-style: none; padding: 16px 22px 20px; display: flex; flex-direction: column; gap: 10px; }
.article-item {
  display: flex; align-items: flex-start; gap: 13px;
  padding: 13px; border-radius: 14px;
  background: var(--surface-2); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.25s; position: relative; overflow: hidden;
}
.article-item::after {
  content: ''; position: absolute; inset: 0;
  background: var(--grad-main); opacity: 0;
  transition: opacity 0.25s; border-radius: 14px;
}
.article-item:hover { border-color: rgba(124,109,250,0.4); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
.article-item:hover::after { opacity: 0.04; }
.article-thumb {
  width: 82px; height: 82px; border-radius: 10px;
  flex-shrink: 0; overflow: hidden;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; font-weight: 800; color: white;
  background: var(--grad-main); position: relative;
}
.article-thumb img { width: 100%; height: 100%; object-fit: cover; }
.article-body { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 5px; z-index: 1; }
.article-title-text {
  font-size: 14px; font-weight: 700; color: var(--text-1);
  line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.article-meta { font-size: 11px; color: var(--text-3); display: flex; align-items: center; gap: 5px; }
.meta-sep { width: 2px; height: 2px; background: var(--text-3); border-radius: 50%; }
.article-foot { display: flex; align-items: center; gap: 10px; font-size: 11px; color: var(--text-3); margin-top: 2px; }
.article-foot-item { display: flex; align-items: center; gap: 3px; }
.article-foot-item.v i { color: var(--accent-blue); }
.article-foot-item.l i { color: var(--accent-3); }

/* ─── Library list ─── */
.library-list { padding: 14px 22px 20px; display: flex; flex-direction: column; gap: 0; }
.library-row {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--border);
  cursor: pointer; transition: all 0.2s;
}
.library-row:first-child { padding-top: 0; }
.library-row:last-child { border-bottom: none; padding-bottom: 0; }
.library-row:hover { opacity: 0.75; }
.library-row:hover .lib-name { color: var(--accent-2); }
.lib-icon {
  width: 38px; height: 38px; border-radius: 10px;
  background: var(--grad-purple);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; color: white; flex-shrink: 0;
  box-shadow: 0 2px 10px rgba(168,85,247,0.25);
}
.lib-body { flex: 1; min-width: 0; }
.lib-name { font-size: 13px; font-weight: 600; color: var(--text-1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 0.2s; }
.lib-desc { font-size: 11px; color: var(--text-3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
.lib-count {
  font-size: 11px; font-weight: 700;
  color: var(--accent-2); background: rgba(168,85,247,0.12);
  border: 1px solid rgba(168,85,247,0.2);
  padding: 3px 9px; border-radius: 100px; flex-shrink: 0;
}

/* ─── Quote ─── */
.quote-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px; padding: 36px 32px;
  text-align: center; position: relative; overflow: hidden;
  margin-bottom: 20px;
}
.quote-card-glow {
  position: absolute; inset: 0; pointer-events: none;
  background: radial-gradient(ellipse at center, rgba(124,109,250,0.1), transparent 65%);
}
.quote-mark { font-size: 48px; line-height: 1; color: var(--accent); opacity: 0.25; display: block; margin-bottom: 16px; }
.quote-body {
  font-family: 'Merriweather', serif;
  font-size: 17px; font-style: italic; line-height: 1.7;
  color: var(--text-1); margin-bottom: 18px; position: relative; z-index: 1;
}
.quote-author { font-size: 12px; font-weight: 600; letter-spacing: 0.05em; color: var(--text-2); }
.quote-author span { color: var(--accent); }

/* ─── Settings row ─── */
.settings-row {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px; padding: 18px 22px;
  display: flex; align-items: center; justify-content: space-between; gap: 16px;
  margin-bottom: 28px;
}
.settings-label { font-size: 14px; font-weight: 600; color: var(--text-1); margin-bottom: 2px; }
.settings-desc { font-size: 12px; color: var(--text-3); }
.toggle-switch {
  width: 52px; height: 30px; border-radius: 15px;
  background: var(--surface-3); border: 1.5px solid var(--border-2);
  cursor: pointer; position: relative; transition: all 0.3s; flex-shrink: 0;
  display: flex; align-items: center; padding: 0 4px;
}
.toggle-switch::after {
  content: ''; width: 20px; height: 20px; border-radius: 50%;
  background: var(--text-3); transition: all 0.3s; transform: translateX(0);
}
body.light-theme .toggle-switch { background: var(--glow-accent); border-color: var(--accent); }
body.light-theme .toggle-switch::after { background: var(--accent); transform: translateX(22px); }

/* ─── States ─── */
.empty-state { text-align: center; padding: 32px 20px; }
.empty-icon {
  width: 52px; height: 52px; border-radius: 50%;
  background: var(--surface-3); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; color: var(--text-3); margin: 0 auto 12px;
}
.empty-title { font-size: 15px; font-weight: 600; color: var(--text-1); margin-bottom: 5px; }
.empty-text { font-size: 12px; color: var(--text-2); }
.loading-state { text-align: center; padding: 32px; color: var(--text-2); font-size: 14px; }
.error-state { text-align: center; padding: 24px; color: #f87171; font-size: 13px; }

/* ─── Footer nav ─── */
.footer-spacer { height: calc(76px + env(safe-area-inset-bottom)); }
.footer-bar {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 450px;
  background: rgba(10,10,14,0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-top: 1px solid var(--border);
  padding: 10px 24px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom));
  display: flex; justify-content: space-around; align-items: center;
  z-index: 100;
}
body.light-theme .footer-bar { background: rgba(240,239,248,0.88); }
.footer-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  background: none; border: none; color: var(--text-3);
  cursor: pointer; transition: color 0.2s; padding: 4px 14px; border-radius: 10px;
}
.footer-btn:hover { color: var(--text-2); }
.footer-btn.active { color: var(--accent); }
.footer-btn i { font-size: 18px; }
.footer-btn span { font-size: 10px; font-weight: 600; letter-spacing: 0.03em; }

@media (max-width: 600px) {
  .page { padding-left: 14px; padding-right: 14px; padding-top: calc(53px + env(safe-area-inset-top) + 16px); }
  .hero { padding: 24px 20px 22px; }
  .hero-title { font-size: 24px; }
  .card-header { padding: 18px 18px 0; }
  .article-list { padding: 14px 16px 18px; gap: 8px; }
  .article-thumb { width: 70px; height: 70px; border-radius: 8px; font-size: 22px; }
  .article-title-text { font-size: 13px; }
  .library-list { padding: 12px 16px 18px; }
  .quote-card { padding: 28px 20px; }
  .quote-body { font-size: 15px; }
  .settings-row { padding: 16px 18px; }
  .header { padding: 12px 16px; }
  .fab-create { bottom: 82px; right: 14px; }
  .footer-bar { padding: 8px 16px; padding-bottom: calc(8px + env(safe-area-inset-bottom)); }
  .footer-btn { padding: 4px 10px; }
  .footer-btn i { font-size: 17px; }
}
</style>
</head>
<body>
<div class="ambient ambient-1"></div>
<div class="ambient ambient-2"></div>

<!-- Header -->
<div class="header-wrapper">
  <div class="header">
    <div class="logo-wrap" onclick="window.location.href='index.html'">
      <img src="IMG_0696.png" class="logo-img" alt="Patholytica">
    </div>
    <div class="header-right">
      <div class="auth-buttons" id="authButtons">
        <a href="login.html" class="btn-login">Log In</a>
      </div>
      <div class="user-welcome" id="userWelcome">
        <div class="user-chip" id="userChip">
          <div class="user-chip-avatar" id="userAvatar">P</div>
          <span class="user-chip-name" id="welcomeLabel">@user</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FAB -->
<button class="fab-create" id="fabCreateBtn" onclick="showCreateModal()">
  <i class="fas fa-plus"></i>
</button>

<!-- Create Modal -->
<div class="create-modal" id="createModal">
  <div class="create-modal-content">
    <div class="create-modal-header">
      <span class="create-modal-title">Create</span>
      <button class="create-modal-close" onclick="closeCreateModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="create-modal-body">
      <div class="create-option" onclick="createArticle()">
        <div class="create-option-icon article"><i class="fas fa-pen-nib"></i></div>
        <div>
          <div class="create-option-title">Article</div>
          <div class="create-option-desc">Write and publish something new</div>
        </div>
      </div>
      <div class="create-option" onclick="createLibrary()">
        <div class="create-option-icon library"><i class="fas fa-layer-group"></i></div>
        <div>
          <div class="create-option-title">Library</div>
          <div class="create-option-desc">Curate a collection of articles</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page -->
<div class="page">

  <!-- Stories -->
  <div class="stories-wrap">
    <div class="stories-scroll" id="storiesScroll">
      <div class="loading-state" style="width:100%;padding:12px 0 0;">Loading…</div>
    </div>
  </div>

  <!-- Hero -->
  <div class="hero card-full">
    <div class="hero-glow"></div>
    <div class="hero-tag"><span class="hero-tag-dot"></span> Live</div>
    <h1 class="hero-title">Patholytica</h1>
    <div class="hero-stats">
      <div class="stat-pill articles"><i class="fas fa-file-alt"></i> <span class="stat-pill-val" id="totalArticles">0</span> articles</div>
      <div class="stat-pill views"><i class="fas fa-eye"></i> <span class="stat-pill-val" id="totalViews">0</span> views</div>
      <div class="stat-pill likes"><i class="fas fa-heart"></i> <span class="stat-pill-val" id="totalLikes">0</span> likes</div>
    </div>
    <p class="hero-desc">Discover insightful articles from our community of writers and researchers.</p>
  </div>

  <!-- Libraries + Articles grid -->
  <div class="grid-2">
    <!-- Libraries -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <div class="card-title-icon purple"><i class="fas fa-layer-group"></i></div>
          Libraries
        </div>
        <span class="count-tag purple" id="libraryCountTag">—</span>
      </div>
      <div class="library-list" id="libraryList">
        <div class="loading-state" style="padding:20px 0;">Loading…</div>
      </div>
    </div>

    <!-- Articles -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <div class="card-title-icon blue"><i class="fas fa-newspaper"></i></div>
          Recent
        </div>
        <span class="count-tag" id="articleCount">—</span>
      </div>
      <ul class="article-list" id="articleList">
        <li class="loading-state">Loading…</li>
      </ul>
    </div>
  </div>

  <!-- Quote -->
  <div class="quote-card">
    <div class="quote-card-glow"></div>
    <i class="fas fa-quote-left quote-mark"></i>
    <p class="quote-body" id="quoteText">Loading…</p>
    <p class="quote-author">— <span id="quoteAuthor">Astronaut</span></p>
  </div>

  <!-- Theme -->
  <div class="settings-row">
    <div>
      <div class="settings-label">Appearance</div>
      <div class="settings-desc">Toggle light / dark mode</div>
    </div>
    <button class="toggle-switch" onclick="toggleTheme()" aria-label="Toggle theme"></button>
  </div>

  <div class="footer-spacer"></div>
</div>

<!-- Footer Nav -->
<div class="footer-bar">
  <button class="footer-btn active" onclick="window.location.href='index.html'">
    <i class="fas fa-home"></i><span>Home</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='https://patholytica.com/dailyfeed'">
    <i class="fas fa-scroll"></i><span>Feed</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='explore.html'">
    <i class="fas fa-search"></i><span>Explore</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='profile.html'">
    <i class="fas fa-user"></i><span>Profile</span>
  </button>
</div>

<script>
const QUOTES = [
  { text: "The Earth is the cradle of humanity, but mankind cannot stay in the cradle forever.", author: "Konstantin Tsiolkovsky" },
  { text: "That's one small step for man, one giant leap for mankind.", author: "Neil Armstrong" },
  { text: "The Earth is a very small stage in a vast cosmic arena.", author: "Carl Sagan" },
  { text: "We choose to go to the Moon not because it is easy, but because it is hard.", author: "John F. Kennedy" },
  { text: "The stars don't look bigger, but they do look brighter.", author: "Sally Ride" },
  { text: "To confine our attention to terrestrial matters would be to limit the human spirit.", author: "Stephen Hawking" },
  { text: "Houston, Tranquility Base here. The Eagle has landed.", author: "Neil Armstrong" },
  { text: "Space travel is life-enhancing, and anything that's life-enhancing is worth doing.", author: "Ray Bradbury" }
];
const q = QUOTES[Math.floor(Math.random()*QUOTES.length)];
document.getElementById('quoteText').textContent = q.text;
document.getElementById('quoteAuthor').textContent = q.author;

function toggleTheme() {
  document.body.classList.toggle('light-theme');
  localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
}
if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-theme');

function fmtNum(n) { return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1000?(n/1000).toFixed(1)+'K':String(n); }
function openArticle(id) { window.location.href = `article.html?id=${id}`; }
function openProfile(u) { window.location.href = `profile.html?username=${u}`; }
function openLibrary(id) { window.location.href = `playlist.html?id=${id}`; }
function showCreateModal() { document.getElementById('createModal').classList.add('show'); }
function closeCreateModal() { document.getElementById('createModal').classList.remove('show'); }
function createArticle() { window.location.href = 'https://patholytica.com/create'; }
function createLibrary() { window.location.href = 'https://patholytica.com/librarycreate'; }
document.getElementById('createModal').addEventListener('click', e => { if(e.target===e.currentTarget) closeCreateModal(); });

const USERNAME_CACHE_KEY = 'patholytica_username_cache';
function getCachedUsername(uid) {
  try { const d=JSON.parse(localStorage.getItem(USERNAME_CACHE_KEY)); if(d&&d.uid===uid&&Date.now()-d.timestamp<86400000) return d.username; } catch(e){}
  return null;
}
function setCachedUsername(uid, username) {
  try { localStorage.setItem(USERNAME_CACHE_KEY, JSON.stringify({uid,username,timestamp:Date.now()})); } catch(e){}
}
function shuffleArray(a) { const r=[...a]; for(let i=r.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[r[i],r[j]]=[r[j],r[i]];} return r; }
window.fmtNum=fmtNum; window.shuffleArray=shuffleArray;
window.getCachedUsername=getCachedUsername; window.setCachedUsername=setCachedUsername;
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
});
const auth = getAuth(app);
const sb = window.supabase.createClient(
  "https://vduqewqyvszfquntmark.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdXFld3F5dnN6ZnF1bnRtYXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MTg3MjgsImV4cCI6MjA4NTE5NDcyOH0.V2JellFmUGgYhKfW-D4CBdcBHyPztOlcgLCBdhnXj7c"
);

async function loadStories(currentUser) {
  const el = document.getElementById('storiesScroll');
  try {
    const {data:articles} = await sb.from('articles').select('firebase_user_id,views');
    if (!articles?.length) { el.innerHTML=''; return; }
    const views = {};
    articles.forEach(a=>{ if(a.firebase_user_id) views[a.firebase_user_id]=(views[a.firebase_user_id]||0)+(a.views||0); });
    let top = Object.entries(views).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([uid])=>uid);
    const {data:users} = await sb.from('users').select('firebase_uid,username,pfp').in('firebase_uid',top);
    if (!users) return;
    el.innerHTML='';
    if (currentUser) {
      const si = document.createElement('div');
      si.className='story-item'; si.id='myStory';
      si.innerHTML=`<div class="story-spin"></div><div class="story-label">You</div>`;
      el.appendChild(si);
      top = top.filter(u=>u!==currentUser.uid);
    }
    top.forEach(uid=>{
      const u=users.find(x=>x.firebase_uid===uid); if(!u) return;
      const init=(u.username||'U')[0].toUpperCase();
      const si=document.createElement('div'); si.className='story-item'; si.onclick=()=>openProfile(u.username);
      si.innerHTML=`<div class="story-ring"><div class="story-ring-inner"><div class="story-avatar-content">${u.pfp?`<img src="${u.pfp}" alt="${u.username}" onerror="this.remove();this.parentElement.textContent='${init}';">`:init}</div></div></div><div class="story-label">${u.username||'?'}</div>`;
      el.appendChild(si);
    });
    if (currentUser) {
      const cu=users.find(u=>u.firebase_uid===currentUser.uid);
      const myEl=document.getElementById('myStory');
      if (myEl) {
        const init=cu?(cu.username||'Y')[0].toUpperCase():'Y';
        myEl.onclick=()=>cu&&openProfile(cu.username);
        myEl.innerHTML=`<div class="story-ring green"><div class="story-ring-inner"><div class="story-avatar-content">${cu?.pfp?`<img src="${cu.pfp}" alt="${cu.username}">`:init}</div></div></div><div class="story-label">You</div>`;
      }
    }
  } catch(e) { el.innerHTML=''; }
}

async function loadArticles() {
  const el=document.getElementById('articleList');
  try {
    const {data:all,error}=await sb.from('articles').select('id,title,created_at,views,likes,firebase_user_id,media(url)').order('created_at',{ascending:false});
    if (error||!all?.length) { el.innerHTML='<div class="empty-state"><div class="empty-icon"><i class="fas fa-file-alt"></i></div><div class="empty-title">No articles yet</div></div>'; return; }
    document.getElementById('totalArticles').textContent=fmtNum(all.length);
    document.getElementById('totalViews').textContent=fmtNum(all.reduce((s,a)=>s+(a.views||0),0));
    document.getElementById('totalLikes').textContent=fmtNum(all.reduce((s,a)=>s+(a.likes||0),0));
    const articles=shuffleArray(all).slice(0,8);
    const uids=[...new Set(articles.map(a=>a.firebase_user_id).filter(Boolean))];
    const {data:users}=await sb.from('users').select('firebase_uid,username').in('firebase_uid',uids);
    const umap={}; if(users) users.forEach(u=>umap[u.firebase_uid]=u);
    el.innerHTML='';
    articles.forEach(article=>{
      const li=document.createElement('li'); li.className='article-item'; li.onclick=()=>openArticle(article.id);
      const u=umap[article.firebase_user_id]; const author=u?.username?`@${u.username}`:'Unknown';
      const diff=Date.now()-new Date(article.created_at);
      const mins=Math.floor(diff/6e4),hrs=Math.floor(diff/36e5),days=Math.floor(diff/864e5);
      const when=mins<60?`${mins}m`:hrs<24?`${hrs}h`:days<7?`${days}d`:new Date(article.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric'});
      const letter=(article.title||'A')[0].toUpperCase();
      const img=article.media?.[0]?.url;
      const thumb=document.createElement('div'); thumb.className='article-thumb';
      if(img){const i=document.createElement('img');i.src=img;i.alt='';i.onerror=()=>{i.remove();thumb.textContent=letter;};thumb.appendChild(i);}else{thumb.textContent=letter;}
      const body=document.createElement('div'); body.className='article-body';
      body.innerHTML=`<div class="article-title-text">${article.title||'Untitled'}</div><div class="article-meta"><span>${author}</span><div class="meta-sep"></div><span>${when}</span></div><div class="article-foot"><div class="article-foot-item v"><i class="fas fa-eye"></i>${fmtNum(article.views||0)}</div><div class="article-foot-item l"><i class="fas fa-heart"></i>${fmtNum(article.likes||0)}</div></div>`;
      li.appendChild(thumb); li.appendChild(body); el.appendChild(li);
    });
    document.getElementById('articleCount').textContent=articles.length;
  } catch(e) { el.innerHTML='<li class="error-state">Error loading</li>'; }
}

async function loadLibraries() {
  const el=document.getElementById('libraryList');
  try {
    const {data:libs,error}=await sb.from('playlists').select('*').order('created_at',{ascending:false}).limit(8);
    if(error||!libs?.length){el.innerHTML='<div class="empty-state"><div class="empty-icon"><i class="fas fa-layer-group"></i></div><div class="empty-title">No libraries yet</div></div>';return;}
    el.innerHTML='';
    document.getElementById('libraryCountTag').textContent=libs.length;
    libs.forEach(lib=>{
      const row=document.createElement('div'); row.className='library-row'; row.onclick=()=>openLibrary(lib.id);
      row.innerHTML=`<div class="lib-icon"><i class="fas fa-bookmark"></i></div><div class="lib-body"><div class="lib-name">${lib.name||'Untitled'}</div><div class="lib-desc">${lib.description||'No description'}</div></div><div class="lib-count">${lib.article_count||0}</div>`;
      el.appendChild(row);
    });
  } catch(e) { el.innerHTML='<div class="error-state">Error loading</div>'; }
}

window.logOut=async()=>{try{await signOut(auth);localStorage.removeItem(USERNAME_CACHE_KEY);window.location.reload();}catch(e){}};

onAuthStateChanged(auth, async user=>{
  const authBtns=document.getElementById('authButtons');
  const userWelcome=document.getElementById('userWelcome');
  const fab=document.getElementById('fabCreateBtn');
  const chip=document.getElementById('userChip');
  const label=document.getElementById('welcomeLabel');
  if(user){
    authBtns.classList.remove('show'); userWelcome.classList.add('show');
    fab?.classList.add('show');
    chip.onclick=window.logOut;
    const cached=getCachedUsername(user.uid);
    if(cached) label.textContent=`@${cached}`;
    try {
      const {data:ud}=await sb.from('users').select('username').eq('firebase_uid',user.uid).single();
      if(ud?.username){label.textContent=`@${ud.username}`;setCachedUsername(user.uid,ud.username);}
    }catch(e){}
  }else{
    authBtns.classList.add('show'); userWelcome.classList.remove('show');
    fab?.classList.remove('show');
  }
  loadStories(user); loadArticles(); loadLibraries();
});
</script>
</body>
</html>