<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica — Library</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-color: #1f1f1f;
  --text-primary: #fff;
  --text-secondary: #aaa;
  --card-bg: #1f1f1f;
  --hover-bg: #2a2a2a;
  --border-color: #303030;
  --accent: #3ea6ff;
  --accent-hover: #2d8ed6;
  --accent-green: #2ecc71;
  --accent-purple: #9b59b6;
}

body.light-theme {
  --bg-color: #f9f9f9;
  --text-primary: #0f0f0f;
  --text-secondary: #606060;
  --card-bg: #f9f9f9;
  --hover-bg: #f0f0f0;
  --border-color: #e5e5e5;
  --accent: #065fd4;
  --accent-hover: #0448a3;
}

* { box-sizing: border-box; }
html, body {
  margin: 0;
  padding: 0;
  min-height: 100%;
  font-family: "Roboto", Arial, sans-serif;
  overflow-x: hidden;
  max-width: 100vw;
}
body {
  background: var(--bg-color);
  color: var(--text-primary);
  transition: background 0.2s ease, color 0.2s ease;
}

.header-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border-color);
  z-index: 40;
  width: 100%;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  max-width: 100%;
  margin: 0 auto;
}
.logo-img {
  height: 28px;
  width: auto;
  cursor: pointer;
  transition: filter 0.2s ease;
}
body.light-theme .logo-img {
  filter: invert(1);
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}
.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: background 0.2s ease;
}
.icon-btn:hover {
  background: var(--hover-bg);
}
.auth-buttons {
  display: none;
  gap: 12px;
}
.auth-buttons.show {
  display: flex;
}
.btn-login {
  padding: 8px 20px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  border: 1px solid var(--border-color);
  background: transparent;
  color: var(--text-primary);
}
.btn-login:hover {
  background: var(--hover-bg);
}
.user-welcome {
  display: none;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  color: var(--text-primary);
}
.user-welcome.show {
  display: flex;
}
.welcome-text {
  font-weight: 500;
  cursor: pointer;
  transition: color 0.2s ease;
}
.welcome-text:hover {
  color: var(--accent);
}

.fab-create {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  border: none;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  box-shadow: 0 4px 12px rgba(62, 166, 255, 0.4);
  transition: all 0.3s ease;
  z-index: 50;
}
.fab-create.show {
  display: flex;
}
.fab-create:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(62, 166, 255, 0.5);
}
.fab-create:active {
  transform: scale(0.95);
}

.create-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.create-modal.show {
  display: flex;
}
.create-modal-content {
  background: var(--card-bg);
  border-radius: 20px;
  width: 100%;
  max-width: 400px;
  border: 1px solid var(--border-color);
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  overflow: hidden;
}
.create-modal-header {
  padding: 24px 28px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.create-modal-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 22px;
  font-weight: 700;
  margin: 0;
}
.create-modal-close {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.2s ease;
}
.create-modal-close:hover {
  background: var(--hover-bg);
  transform: rotate(90deg);
}
.create-modal-body {
  padding: 20px 28px 28px;
}
.create-option {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  border-radius: 12px;
  background: var(--bg-color);
  border: 2px solid var(--border-color);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 12px;
}
.create-option:last-child {
  margin-bottom: 0;
}
.create-option:hover {
  border-color: var(--accent);
  background: var(--hover-bg);
  transform: translateX(4px);
}
.create-option-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: white;
  flex-shrink: 0;
}
.create-option-icon.article {
  background: linear-gradient(135deg, var(--accent-green) 0%, #27ae60 100%);
}
.create-option-icon.library {
  background: linear-gradient(135deg, var(--accent-purple) 0%, #8e44ad 100%);
}
.create-option-content {
  flex: 1;
}
.create-option-title {
  font-size: 17px;
  font-weight: 600;
  margin: 0 0 4px 0;
  color: var(--text-primary);
}
.create-option-desc {
  font-size: 13px;
  color: var(--text-secondary);
  margin: 0;
}

.list-container {
  max-width: 900px;
  width: 100%;
  margin: 0 auto;
  padding: 24px 24px 0;
  padding-top: calc(53px + env(safe-area-inset-top) + 24px);
}

.stories-section {
  margin-bottom: 24px;
  position: relative;
}
.stories-scroll {
  display: flex;
  gap: 16px;
  overflow-x: auto;
  overflow-y: hidden;
  padding: 16px 0;
  scrollbar-width: none;
  -ms-overflow-style: none;
}
.stories-scroll::-webkit-scrollbar {
  display: none;
}
.story-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  flex-shrink: 0;
  transition: transform 0.2s ease;
}
.story-item:hover {
  transform: scale(1.05);
}
.story-avatar {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%);
  padding: 3px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}
.story-avatar-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--bg-color);
  padding: 3px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.story-avatar-content {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  font-weight: 600;
  color: white;
  overflow: hidden;
}
.story-avatar-content img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.story-username {
  font-size: 12px;
  color: var(--text-primary);
  max-width: 72px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-align: center;
}
.story-item.current-user .story-avatar {
  background: linear-gradient(135deg, var(--accent-green) 0%, #27ae60 100%);
}
.story-loading {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  border: 3px solid var(--border-color);
  border-top: 3px solid var(--accent-green);
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.home-hero {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 32px;
}
.hero-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 36px;
  font-weight: 700;
  margin: 0 0 12px 0;
  color: var(--text-primary);
}
.hero-stats {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 16px;
  font-size: 15px;
  color: var(--text-secondary);
  flex-wrap: wrap;
}
.hero-stat {
  display: flex;
  align-items: center;
  gap: 6px;
}
.hero-stat-value {
  font-weight: 700;
  color: var(--text-primary);
}
.hero-description {
  font-size: 15px;
  line-height: 1.6;
  color: var(--text-secondary);
  margin: 0;
}

.articles-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 32px;
}
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
}
.section-header:hover .section-title {
  color: var(--accent);
}
.section-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 28px;
  font-weight: 700;
  margin: 0;
  color: var(--text-primary);
  transition: color 0.2s ease;
}
.section-header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}
.count-badge {
  background: var(--accent);
  color: white;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}
.collapse-icon {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: var(--hover-bg);
  font-size: 16px;
  color: var(--text-primary);
  transition: all 0.3s ease;
}
.collapse-icon.collapsed {
  transform: rotate(-90deg);
}

.article-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: none;
  padding-top: 24px;
}
.article-list.expanded {
  display: block;
}
.article-item {
  background: var(--bg-color);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  gap: 16px;
  align-items: flex-start;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}
.article-item:last-child {
  margin-bottom: 0;
}
.article-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
  transform: scaleY(0);
  transition: transform 0.3s ease;
}
.article-item:hover::before {
  transform: scaleY(1);
}
.article-item:hover {
  transform: translateX(8px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  border-color: var(--accent);
}
.article-thumbnail {
  width: 100px;
  height: 100px;
  border-radius: 10px;
  flex-shrink: 0;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: 700;
  color: white;
  background: var(--accent);
}
.article-thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.article-body {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.article-title {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 20px;
  font-weight: 700;
  margin: 0;
  line-height: 1.3;
  color: var(--text-primary);
  word-wrap: break-word;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.article-meta {
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.meta-dot {
  width: 3px;
  height: 3px;
  background: var(--text-secondary);
  border-radius: 50%;
  flex-shrink: 0;
}
.article-stats {
  display: flex;
  align-items: center;
  gap: 14px;
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.stat-item {
  display: flex;
  align-items: center;
  gap: 5px;
}
.stat-item.views i { color: var(--accent); }
.stat-item.likes i { color: #ef4444; }

/* ── Libraries Section — compact list ── */
.libraries-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px 32px;
  margin-bottom: 32px;
}
.library-list {
  display: flex;
  flex-direction: column;
  gap: 0;
}
.library-row {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
  transition: opacity 0.2s ease;
}
.library-row:last-child {
  border-bottom: none;
  padding-bottom: 0;
}
.library-row:first-child {
  padding-top: 0;
}
.library-row:hover {
  opacity: 0.75;
}
.library-row:hover .library-row-title {
  color: var(--accent-purple);
}
.library-row-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--accent-purple) 0%, #8e44ad 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: white;
  flex-shrink: 0;
}
.library-row-body {
  flex: 1;
  min-width: 0;
}
.library-row-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0 0 2px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: color 0.2s ease;
}
.library-row-meta {
  font-size: 12px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.library-row-count {
  font-size: 12px;
  color: var(--accent-purple);
  font-weight: 600;
  flex-shrink: 0;
  white-space: nowrap;
}

.quote-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 40px 32px;
  margin-bottom: 16px;
  text-align: center;
}
.quote-icon {
  font-size: 48px;
  color: var(--accent);
  margin-bottom: 16px;
  opacity: 0.3;
}
.quote-text {
  font-family: 'Merriweather', Georgia, serif;
  font-size: 20px;
  font-style: italic;
  line-height: 1.6;
  color: var(--text-primary);
  margin: 0 0 16px 0;
}
.quote-author {
  font-size: 15px;
  color: var(--text-secondary);
  font-weight: 500;
}

.theme-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px 32px;
  margin-bottom: 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.theme-section-content {
  flex: 1;
}
.theme-section-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 6px 0;
  color: var(--text-primary);
}
.theme-section-desc {
  font-size: 14px;
  color: var(--text-secondary);
  margin: 0;
}
.theme-toggle-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--hover-bg);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.3s ease;
}
.theme-toggle-btn:hover {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
  transform: rotate(180deg);
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
}
.empty-state-icon {
  width: 60px;
  height: 60px;
  margin: 0 auto 16px;
  background: var(--hover-bg);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  opacity: 0.5;
}
.empty-state-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0 0 8px 0;
  color: var(--text-primary);
}
.empty-state-text {
  font-size: 14px;
  margin: 0;
}

.footer-spacer {
  height: calc(72px + env(safe-area-inset-bottom));
}
.footer {
  padding: 16px 0;
  text-align: center;
  color: var(--text-secondary);
  font-size: 14px;
  line-height: 1.6;
}

/* Enhanced Loading States */
.loading-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-secondary);
  font-size: 15px;
}
.loading-progress {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border-color);
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
.progress-bar-container {
  width: 100%;
  max-width: 200px;
  height: 6px;
  background: var(--border-color);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}
.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
  border-radius: 3px;
  transition: width 0.3s ease;
  position: relative;
  overflow: hidden;
}
.progress-bar::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 1.5s infinite;
}
@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
.progress-percentage {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  margin-top: 8px;
}
.loading-text {
  font-size: 14px;
  color: var(--text-secondary);
}

.error-state {
  text-align: center;
  padding: 40px;
  color: #ff4444;
  font-size: 16px;
}

.footer-bar {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 450px;
  background: var(--card-bg);
  border-top: 1px solid var(--border-color);
  padding: 8px 24px;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 100;
}
.footer-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  transition: color 0.2s ease;
  padding: 6px 12px;
}
.footer-btn:hover { color: var(--text-primary); }
.footer-btn.active { color: var(--accent); }
.footer-btn i { font-size: 20px; }
.footer-btn span { font-size: 10px; font-weight: 500; }

@media (max-width: 768px) {
  .fab-create {
    bottom: 80px;
    right: 16px;
  }
  .list-container {
    padding: 16px 16px 0;
    padding-top: calc(53px + env(safe-area-inset-top) + 16px);
  }
  .stories-section {
    margin-bottom: 20px;
  }
  .stories-scroll {
    gap: 12px;
    padding: 12px 0;
  }
  .story-avatar, .story-loading {
    width: 64px;
    height: 64px;
  }
  .story-username {
    font-size: 11px;
    max-width: 64px;
  }
  .home-hero {
    padding: 24px;
    margin-bottom: 24px;
  }
  .hero-title { font-size: 28px; }
  .hero-stats { font-size: 13px; gap: 16px; }
  .hero-description { font-size: 14px; }
  .articles-section { padding: 20px; }
  .libraries-section { padding: 20px; }
  .section-title { font-size: 22px; }
  .article-thumbnail {
    width: 80px;
    height: 80px;
    font-size: 26px;
    border-radius: 8px;
  }
  .article-title { font-size: 17px; }
  .article-meta { font-size: 12px; }
  .article-stats { font-size: 12px; }
  .library-row { padding: 12px 0; gap: 12px; }
  .library-row-icon {
    width: 36px;
    height: 36px;
    font-size: 14px;
    border-radius: 8px;
  }
  .library-row-title { font-size: 14px; }
  .library-row-meta { font-size: 11px; }
  .quote-section { padding: 32px 24px; }
  .quote-text { font-size: 17px; }
  .quote-author { font-size: 14px; }
  .theme-section { padding: 20px 24px; }
  .theme-section-title { font-size: 16px; }
  .theme-section-desc { font-size: 13px; }
  .theme-toggle-btn { width: 44px; height: 44px; font-size: 18px; }
  .footer { padding: 14px 0; font-size: 13px; }
  .auth-buttons { gap: 8px; }
  .btn-login { padding: 6px 16px; font-size: 13px; }
  .footer-bar {
    padding: 8px 16px;
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
  }
  .footer-btn { padding: 6px 8px; }
  .footer-btn i { font-size: 18px; }
  .footer-btn span { font-size: 9px; }
  .create-modal-content { max-width: 90%; }
  .create-option { padding: 16px; }
  .create-option-icon { width: 42px; height: 42px; font-size: 20px; }
  .create-option-title { font-size: 16px; }
  .loading-spinner { width: 32px; height: 32px; }
  .progress-bar-container { max-width: 160px; }
}
</style>
</head>
<body>

<div class="header-wrapper">
  <div class="header">
    <img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo" onclick="window.location.href='index.html'">
    <div class="header-actions">
      <div class="auth-buttons" id="authButtons">
        <a href="login.html" class="btn-login">Log In</a>
      </div>
      <div class="user-welcome" id="userWelcome">
        <span class="welcome-text" id="welcomeText">Welcome</span>
      </div>
    </div>
  </div>
</div>

<button class="fab-create" id="fabCreateBtn" onclick="showCreateModal()" title="Create">
  <i class="fas fa-plus"></i>
</button>

<!-- Create Modal -->
<div class="create-modal" id="createModal">
  <div class="create-modal-content">
    <div class="create-modal-header">
      <h2 class="create-modal-title">Create</h2>
      <button class="create-modal-close" onclick="closeCreateModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="create-modal-body">
      <div class="create-option" onclick="createArticle()">
        <div class="create-option-icon article">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="create-option-content">
          <h3 class="create-option-title">Article</h3>
          <p class="create-option-desc">Write and publish a new article</p>
        </div>
      </div>
      <div class="create-option" onclick="createLibrary()">
        <div class="create-option-icon library">
          <i class="fas fa-bookmark"></i>
        </div>
        <div class="create-option-content">
          <h3 class="create-option-title">Library</h3>
          <p class="create-option-desc">Create a collection of articles</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="list-container">

  <!-- Stories Carousel -->
  <div class="stories-section">
    <div class="stories-scroll" id="storiesScroll">
      <div class="loading-state" style="width: 100%; padding: 20px;">
        <div class="loading-progress">
          <div class="loading-spinner"></div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="storiesProgress" style="width: 0%"></div>
          </div>
          <div class="progress-percentage" id="storiesPercentage">0%</div>
          <div class="loading-text">Loading profiles...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hero Section -->
  <div class="home-hero">
    <h1 class="hero-title">Welcome to Patholytica</h1>
    <div class="hero-stats">
      <div class="hero-stat">
        <span class="hero-stat-value" id="totalArticles">0</span>
        <span>articles</span>
      </div>
      <div class="hero-stat">
        <span class="hero-stat-value" id="totalViews">0</span>
        <span>total views</span>
      </div>
      <div class="hero-stat">
        <span class="hero-stat-value" id="totalLikes">0</span>
        <span>total likes</span>
      </div>
    </div>
    <p class="hero-description">Discover insightful articles from our community of writers and researchers.</p>
  </div>

  <!-- Libraries Section — compact list -->
  <div class="libraries-section">
    <div class="section-header">
      <h2 class="section-title">Featured Libraries</h2>
    </div>
    <div class="library-list" id="libraryList">
      <div class="loading-state" style="padding: 20px 0;">
        <div class="loading-progress">
          <div class="loading-spinner"></div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="librariesProgress" style="width: 0%"></div>
          </div>
          <div class="progress-percentage" id="librariesPercentage">0%</div>
          <div class="loading-text">Loading libraries...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Articles Section -->
  <div class="articles-section">
    <div class="section-header" onclick="toggleArticles()">
      <h2 class="section-title">Recent Articles</h2>
      <div class="section-header-right">
        <span class="count-badge" id="articleCount">0</span>
        <div class="collapse-icon collapsed" id="collapseIcon">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </div>
    <ul class="article-list" id="articleList"></ul>
  </div>

  <!-- Quote Section -->
  <div class="quote-section">
    <div class="quote-icon">
      <i class="fas fa-quote-left"></i>
    </div>
    <p class="quote-text" id="quoteText">Loading quote...</p>
    <p class="quote-author" id="quoteAuthor">— Astronaut</p>
  </div>

  <!-- Theme Toggle Section -->
  <div class="theme-section">
    <div class="theme-section-content">
      <h3 class="theme-section-title">Appearance</h3>
      <p class="theme-section-desc">Switch between light and dark themes</p>
    </div>
    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">
      <i class="fas fa-circle-half-stroke"></i>
    </button>
  </div>

  <div class="footer-spacer"></div>
</div>

<!-- Footer Bar Navigation -->
<div class="footer-bar">
  <button class="footer-btn active" onclick="window.location.href='index.html'">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='https://patholytica.com/dailyfeed'">
    <i class="fas fa-scroll"></i>
    <span>Feed</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='explore.html'">
    <i class="fas fa-search"></i>
    <span>Explore</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='profile.html'">
    <i class="fas fa-user"></i>
    <span>Profile</span>
  </button>
</div>

<script>
  const astronautQuotes = [
    { text: "The Earth is the cradle of humanity, but mankind cannot stay in the cradle forever.", author: "Konstantin Tsiolkovsky" },
    { text: "That's one small step for man, one giant leap for mankind.", author: "Neil Armstrong" },
    { text: "The view of the Earth from the Moon fascinated me—a small disk, 240,000 miles away. It was hard to think that that little thing held so many problems, so many frustrations.", author: "Jim Lovell" },
    { text: "Space exploration is a force of nature unto itself that no other force in society can rival.", author: "Neil deGrasse Tyson" },
    { text: "To confine our attention to terrestrial matters would be to limit the human spirit.", author: "Stephen Hawking" },
    { text: "The Earth is a very small stage in a vast cosmic arena.", author: "Carl Sagan" },
    { text: "We choose to go to the Moon in this decade and do the other things, not because they are easy, but because they are hard.", author: "John F. Kennedy" },
    { text: "Houston, Tranquility Base here. The Eagle has landed.", author: "Neil Armstrong" },
    { text: "I looked and looked but I didn't see God.", author: "Yuri Gagarin" },
    { text: "The rockets... can be built so powerfully that they could be capable of carrying a man aloft.", author: "Hermann Oberth" },
    { text: "When you're finally up on the Moon, looking back at the Earth, all these differences and nationalistic traits are pretty well going to blend and you're going to get a concept that maybe this is really one world.", author: "Frank Borman" },
    { text: "The stars don't look bigger, but they do look brighter.", author: "Sally Ride" },
    { text: "Space travel is life-enhancing, and anything that's life-enhancing is worth doing.", author: "Ray Bradbury" }
  ];

  const randomQuote = astronautQuotes[Math.floor(Math.random() * astronautQuotes.length)];
  document.getElementById('quoteText').textContent = randomQuote.text;
  document.getElementById('quoteAuthor').textContent = `— ${randomQuote.author}`;

  function toggleTheme() {
    document.body.classList.toggle('light-theme');
    localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
  }

  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light-theme");
  }

  let articlesLoaded = false;

  function updateProgress(elementId, percentageId, progress) {
    const bar = document.getElementById(elementId);
    const text = document.getElementById(percentageId);
    if (bar) bar.style.width = progress + '%';
    if (text) text.textContent = progress + '%';
  }

  function toggleArticles() {
    const articleList = document.getElementById('articleList');
    const collapseIcon = document.getElementById('collapseIcon');
    
    articleList.classList.toggle('expanded');
    collapseIcon.classList.toggle('collapsed');

    if (!articlesLoaded && articleList.classList.contains('expanded')) {
      articlesLoaded = true;
      loadArticles();
    }
  }

  function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
  }

  function openArticle(articleId) {
    window.location.href = `article.html?id=${articleId}`;
  }

  function openProfile(username) {
    window.location.href = `profile.html?username=${username}`;
  }

  function openLibrary(libraryId) {
    window.location.href = `playlist.html?id=${libraryId}`;
  }

  function showCreateModal() {
    document.getElementById('createModal').classList.add('show');
  }

  function closeCreateModal() {
    document.getElementById('createModal').classList.remove('show');
  }

  function createArticle() {
    window.location.href = 'https://patholytica.com/create';
  }

  function createLibrary() {
    window.location.href = 'https://patholytica.com/librarycreate';
  }

  document.getElementById('createModal').addEventListener('click', function(e) {
    if (e.target === this) closeCreateModal();
  });

  const USERNAME_CACHE_KEY = 'patholytica_username_cache';
  const CACHE_DURATION = 24 * 60 * 60 * 1000;

  function getCachedUsername(uid) {
    try {
      const cache = localStorage.getItem(USERNAME_CACHE_KEY);
      if (!cache) return null;
      const data = JSON.parse(cache);
      if (data.uid === uid && data.timestamp && (Date.now() - data.timestamp < CACHE_DURATION)) {
        return data.username;
      }
    } catch (e) {
      console.error('Error reading username cache:', e);
    }
    return null;
  }

  function setCachedUsername(uid, username) {
    try {
      localStorage.setItem(USERNAME_CACHE_KEY, JSON.stringify({
        uid, username, timestamp: Date.now()
      }));
    } catch (e) {
      console.error('Error setting username cache:', e);
    }
  }

  function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const supabase = window.supabase.createClient(
  "https://vduqewqyvszfquntmark.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdXFld3F5dnN6ZnF1bnRtYXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MTg3MjgsImV4cCI6MjA4NTE5NDcyOH0.V2JellFmUGgYhKfW-D4CBdcBHyPztOlcgLCBdhnXj7c"
);

async function loadStories(currentUser) {
  const storiesScroll = document.getElementById('storiesScroll');
  
  updateProgress('storiesProgress', 'storiesPercentage', 20);
  
  try {
    const { data: articles } = await supabase
      .from('articles')
      .select('firebase_user_id, views');

    updateProgress('storiesProgress', 'storiesPercentage', 40);

    if (!articles || articles.length === 0) {
      storiesScroll.innerHTML = `
        <div class="empty-state" style="width: 100%;">
          <div class="empty-state-icon"><i class="fas fa-users"></i></div>
          <h3 class="empty-state-title">No profiles yet</h3>
          <p class="empty-state-text">Be the first to create content</p>
        </div>`;
      return;
    }

    const userViews = {};
    articles.forEach(article => {
      if (article.firebase_user_id) {
        userViews[article.firebase_user_id] = (userViews[article.firebase_user_id] || 0) + (article.views || 0);
      }
    });

    updateProgress('storiesProgress', 'storiesPercentage', 60);

    let topUsers = Object.entries(userViews)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)
      .map(([uid, views]) => ({ firebase_uid: uid, totalViews: views }));

    const { data: users } = await supabase
      .from('users')
      .select('firebase_uid, username, pfp')
      .in('firebase_uid', topUsers.map(u => u.firebase_uid));

    updateProgress('storiesProgress', 'storiesPercentage', 80);

    if (!users) {
      storiesScroll.innerHTML = '<div class="error-state">Error loading profiles</div>';
      return;
    }

    storiesScroll.innerHTML = '';

    if (currentUser) {
      const storyItem = document.createElement('div');
      storyItem.className = 'story-item current-user';
      storyItem.id = 'currentUserStory';
      storyItem.innerHTML = `
        <div class="story-loading"></div>
        <div class="story-username">You</div>`;
      storiesScroll.appendChild(storyItem);
      topUsers = topUsers.filter(u => u.firebase_uid !== currentUser.uid);
    }

    topUsers.forEach(topUser => {
      const user = users.find(u => u.firebase_uid === topUser.firebase_uid);
      if (!user) return;
      const initial = user.username ? user.username[0].toUpperCase() : 'U';
      const storyItem = document.createElement('div');
      storyItem.className = 'story-item';
      storyItem.onclick = () => openProfile(user.username);
      const avatarHTML = user.pfp
        ? `<img src="${user.pfp}" alt="${user.username}" onerror="this.remove(); this.parentElement.textContent='${initial}';">`
        : initial;
      storyItem.innerHTML = `
        <div class="story-avatar">
          <div class="story-avatar-inner">
            <div class="story-avatar-content">${avatarHTML}</div>
          </div>
        </div>
        <div class="story-username">${user.username || 'Unknown'}</div>`;
      storiesScroll.appendChild(storyItem);
    });

    updateProgress('storiesProgress', 'storiesPercentage', 100);

    if (currentUser) {
      const currentUserData = users.find(u => u.firebase_uid === currentUser.uid);
      if (currentUserData) {
        const initial = currentUserData.username ? currentUserData.username[0].toUpperCase() : 'Y';
        const avatarHTML = currentUserData.pfp
          ? `<img src="${currentUserData.pfp}" alt="${currentUserData.username}">`
          : initial;
        const currentStoryItem = document.getElementById('currentUserStory');
        if (currentStoryItem) {
          currentStoryItem.onclick = () => openProfile(currentUserData.username);
          currentStoryItem.innerHTML = `
            <div class="story-avatar">
              <div class="story-avatar-inner">
                <div class="story-avatar-content">${avatarHTML}</div>
              </div>
            </div>
            <div class="story-username">You</div>`;
        }
      }
    }
  } catch (err) {
    console.error('Error loading stories:', err);
    storiesScroll.innerHTML = '<div class="error-state">Error loading profiles</div>';
  }
}

async function loadArticles() {
  const articleList = document.getElementById('articleList');
  
  articleList.innerHTML = `
    <li class="loading-state">
      <div class="loading-progress">
        <div class="loading-spinner"></div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="articlesProgress" style="width: 0%"></div>
        </div>
        <div class="progress-percentage" id="articlesPercentage">0%</div>
        <div class="loading-text">Loading articles...</div>
      </div>
    </li>`;
  
  updateProgress('articlesProgress', 'articlesPercentage', 20);
  
  try {
    const { data: allArticles, error: articlesError } = await supabase
      .from('articles')
      .select('id, title, created_at, views, likes, firebase_user_id, media(url)')
      .order('created_at', { ascending: false });

    updateProgress('articlesProgress', 'articlesPercentage', 50);

    if (articlesError) {
      articleList.innerHTML = '<li class="error-state">Error loading articles: ' + articlesError.message + '</li>';
      return;
    }

    if (!allArticles || allArticles.length === 0) {
      articleList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"><i class="fas fa-file-alt"></i></div>
          <h3 class="empty-state-title">No articles yet</h3>
          <p class="empty-state-text">Be the first to publish an article</p>
        </div>`;
      document.getElementById('articleCount').textContent = '0';
      return;
    }

    updateProgress('articlesProgress', 'articlesPercentage', 70);

    const shuffledArticles = window.shuffleArray(allArticles);
    const articles = shuffledArticles.slice(0, 8);

    const firebaseUserIds = [...new Set(articles.map(a => a.firebase_user_id).filter(Boolean))];
    const { data: users } = await supabase
      .from('users')
      .select('firebase_uid, username')
      .in('firebase_uid', firebaseUserIds);

    updateProgress('articlesProgress', 'articlesPercentage', 85);

    const userMap = {};
    if (users) users.forEach(u => { userMap[u.firebase_uid] = u; });

    articleList.innerHTML = '';

    articles.forEach(article => {
      const li = document.createElement('li');
      li.className = 'article-item';
      li.onclick = () => openArticle(article.id);

      const user = userMap[article.firebase_user_id];
      const authorName = user?.username ? `@${user.username}` : 'Unknown';

      const date = new Date(article.created_at);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      let formattedDate;
      if (diffMins < 60) formattedDate = `${diffMins}m ago`;
      else if (diffHours < 24) formattedDate = `${diffHours}h ago`;
      else if (diffDays < 7) formattedDate = `${diffDays}d ago`;
      else formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

      const firstLetter = (article.title || 'A')[0].toUpperCase();
      const articleImage = article.media && article.media.length > 0 ? article.media[0].url : null;

      const thumbDiv = document.createElement('div');
      thumbDiv.className = 'article-thumbnail';
      if (articleImage) {
        const img = document.createElement('img');
        img.src = articleImage;
        img.alt = article.title || 'Article';
        img.onerror = () => { img.remove(); thumbDiv.textContent = firstLetter; };
        thumbDiv.appendChild(img);
      } else {
        thumbDiv.textContent = firstLetter;
      }

      const bodyDiv = document.createElement('div');
      bodyDiv.className = 'article-body';
      bodyDiv.innerHTML = `
        <h2 class="article-title">${article.title || 'Untitled'}</h2>
        <div class="article-meta">
          <span>${authorName}</span>
          <div class="meta-dot"></div>
          <span>${formattedDate}</span>
        </div>
        <div class="article-stats">
          <div class="stat-item views">
            <i class="fas fa-eye"></i>
            <span>${window.formatNumber(article.views || 0)}</span>
          </div>
          <div class="stat-item likes">
            <i class="fas fa-heart"></i>
            <span>${window.formatNumber(article.likes || 0)}</span>
          </div>
        </div>`;

      li.appendChild(thumbDiv);
      li.appendChild(bodyDiv);
      articleList.appendChild(li);
    });

    updateProgress('articlesProgress', 'articlesPercentage', 100);
    document.getElementById('articleCount').textContent = '8';
  } catch (err) {
    articleList.innerHTML = '<li class="error-state">An unexpected error occurred: ' + err.message + '</li>';
  }
}

async function loadLibraries() {
  const libraryList = document.getElementById('libraryList');
  
  updateProgress('librariesProgress', 'librariesPercentage', 30);
  
  try {
    const { data: libraries, error } = await supabase
      .from('playlists')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(10);

    updateProgress('librariesProgress', 'librariesPercentage', 70);

    if (error || !libraries || libraries.length === 0) {
      libraryList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon"><i class="fas fa-bookmark"></i></div>
          <h3 class="empty-state-title">No libraries yet</h3>
          <p class="empty-state-text">Create the first library</p>
        </div>`;
      return;
    }

    libraryList.innerHTML = '';

    libraries.forEach(library => {
      const articleCount = library.article_count || 0;
      const row = document.createElement('div');
      row.className = 'library-row';
      row.onclick = () => openLibrary(library.id);
      row.innerHTML = `
        <div class="library-row-icon">
          <i class="fas fa-bookmark"></i>
        </div>
        <div class="library-row-body">
          <div class="library-row-title">${library.name || 'Untitled Library'}</div>
          <div class="library-row-meta">${library.description || 'No description'}</div>
        </div>
        <div class="library-row-count">${articleCount} articles</div>`;
      libraryList.appendChild(row);
    });

    updateProgress('librariesProgress', 'librariesPercentage', 100);
  } catch (err) {
    console.error('Error loading libraries:', err);
    libraryList.innerHTML = '<div class="error-state">Error loading libraries</div>';
  }
}

async function loadStats() {
  try {
    const { data: allArticles } = await supabase
      .from('articles')
      .select('views, likes');

    if (allArticles && allArticles.length > 0) {
      const totalViews = allArticles.reduce((sum, a) => sum + (a.views || 0), 0);
      const totalLikes = allArticles.reduce((sum, a) => sum + (a.likes || 0), 0);
      document.getElementById('totalArticles').textContent = window.formatNumber(allArticles.length);
      document.getElementById('totalViews').textContent = window.formatNumber(totalViews);
      document.getElementById('totalLikes').textContent = window.formatNumber(totalLikes);
      document.getElementById('articleCount').textContent = '8';
    }
  } catch (err) {
    console.error('Error loading stats:', err);
  }
}

window.logOut = async function () {
  try {
    await signOut(auth);
    localStorage.removeItem('patholytica_username_cache');
    window.location.reload();
  } catch (error) {
    alert("Error logging out. Please try again.");
  }
};

onAuthStateChanged(auth, async (user) => {
  const authButtons = document.getElementById('authButtons');
  const userWelcome = document.getElementById('userWelcome');
  const welcomeText = document.getElementById('welcomeText');
  const fabCreateBtn = document.getElementById('fabCreateBtn');

  if (user) {
    authButtons.classList.remove('show');
    userWelcome.classList.add('show');
    if (fabCreateBtn) fabCreateBtn.classList.add('show');
    welcomeText.onclick = window.logOut;
    welcomeText.style.cursor = 'pointer';

    const cachedUsername = window.getCachedUsername(user.uid);
    if (cachedUsername) {
      welcomeText.textContent = `@${cachedUsername}`;
    } else {
      welcomeText.textContent = 'Welcome';
    }

    try {
      const { data: userData } = await supabase
        .from('users')
        .select('username')
        .eq('firebase_uid', user.uid)
        .single();
      if (userData?.username) {
        welcomeText.textContent = `@${userData.username}`;
        window.setCachedUsername(user.uid, userData.username);
      }
    } catch (error) {
      console.error('Error fetching username:', error);
    }
  } else {
    authButtons.classList.add('show');
    userWelcome.classList.remove('show');
    if (fabCreateBtn) fabCreateBtn.classList.remove('show');
  }

  loadStories(user);
  loadLibraries();
  loadStats();
});
</script>
</body>
</html>