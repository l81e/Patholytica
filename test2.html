<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica — Create Library</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-color: #1f1f1f;
  --text-primary: #fff;
  --text-secondary: #aaa;
  --card-bg: #1f1f1f;
  --hover-bg: #2a2a2a;
  --border-color: #303030;
  --accent: #3ea6ff;
  --accent-hover: #2d8ed6;
  --accent-purple: #9b59b6;
  --accent-green: #2ecc71;
}body.light-theme {
–bg-color: #f9f9f9;
–text-primary: #0f0f0f;
–text-secondary: #606060;
–card-bg: #f9f9f9;
–hover-bg: #f0f0f0;
–border-color: #e5e5e5;
–accent: #065fd4;
–accent-hover: #0448a3;
}
	∙	{
box-sizing: border-box;
margin: 0;
padding: 0;
}
html, body {
min-height: 100%;
font-family: “Inter”, -apple-system, BlinkMacSystemFont, sans-serif;
overflow-x: hidden;
max-width: 100vw;
}
body {
background: var(–bg-color);
color: var(–text-primary);
transition: background 0.2s ease, color 0.2s ease;
}
.header-wrapper {
position: fixed;
top: 0;
left: 0;
right: 0;
background: var(–bg-color);
padding-top: env(safe-area-inset-top);
border-bottom: 1px solid var(–border-color);
z-index: 40;
width: 100%;
}
.header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 12px 24px;
max-width: 100%;
margin: 0 auto;
}
.logo-img {
height: 28px;
width: auto;
cursor: pointer;
transition: filter 0.2s ease;
}
body.light-theme .logo-img {
filter: invert(1);
}
.header-actions {
display: flex;
align-items: center;
gap: 16px;
}
.user-welcome {
display: none;
align-items: center;
gap: 12px;
font-size: 14px;
color: var(–text-primary);
}
.user-welcome.show {
display: flex;
}
.welcome-text {
font-weight: 500;
cursor: pointer;
transition: color 0.2s ease;
}
.welcome-text:hover {
color: var(–accent);
}
/* Main Container */
.main-container {
max-width: 800px;
width: 100%;
margin: 0 auto;
padding: 100px 24px 100px;
}
/* Page Header */
.page-header {
text-align: center;
margin-bottom: 48px;
}
.page-icon {
width: 80px;
height: 80px;
background: linear-gradient(135deg, var(–accent-purple) 0%, #8e44ad 100%);
border-radius: 20px;
display: flex;
align-items: center;
justify-content: center;
margin: 0 auto 24px;
font-size: 36px;
color: white;
box-shadow: 0 8px 24px rgba(155, 89, 182, 0.4);
}
.page-title {
font-family: ‘Merriweather’, Georgia, serif;
font-size: 42px;
font-weight: 700;
margin: 0 0 12px 0;
color: var(–text-primary);
}
.page-subtitle {
font-size: 16px;
color: var(–text-secondary);
max-width: 500px;
margin: 0 auto;
line-height: 1.6;
}
/* Form Card */
.form-card {
background: var(–card-bg);
border: 1px solid var(–border-color);
border-radius: 24px;
padding: 40px;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}
.form-section {
margin-bottom: 40px;
}
.form-section:last-of-type {
margin-bottom: 0;
}
.section-title {
font-size: 18px;
font-weight: 700;
color: var(–text-primary);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 12px;
}
.section-icon {
width: 32px;
height: 32px;
background: linear-gradient(135deg, var(–accent-purple) 0%, #8e44ad 100%);
border-radius: 8px;
display: flex;
align-items: center;
justify-content: center;
font-size: 16px;
color: white;
}
.form-group {
margin-bottom: 24px;
}
.form-label {
display: block;
font-size: 14px;
font-weight: 600;
color: var(–text-primary);
margin-bottom: 8px;
}
.form-label-required {
color: #ef4444;
margin-left: 4px;
}
.form-input, .form-textarea {
width: 100%;
padding: 14px 18px;
border: 2px solid var(–border-color);
border-radius: 12px;
background: var(–bg-color);
color: var(–text-primary);
font-size: 15px;
font-family: inherit;
transition: all 0.2s ease;
}
.form-input:focus, .form-textarea:focus {
outline: none;
border-color: var(–accent-purple);
box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.1);
}
.form-textarea {
resize: vertical;
min-height: 120px;
line-height: 1.6;
}
.char-count {
font-size: 12px;
color: var(–text-secondary);
text-align: right;
margin-top: 4px;
}
.form-hint {
font-size: 13px;
color: var(–text-secondary);
margin-top: 6px;
}
/* Article Search */
.search-box {
position: relative;
margin-bottom: 20px;
}
.search-icon {
position: absolute;
left: 16px;
top: 50%;
transform: translateY(-50%);
color: var(–text-secondary);
font-size: 16px;
pointer-events: none;
}
.search-input {
width: 100%;
padding: 14px 18px 14px 48px;
border: 2px solid var(–border-color);
border-radius: 12px;
background: var(–bg-color);
color: var(–text-primary);
font-size: 15px;
transition: all 0.2s ease;
}
.search-input:focus {
outline: none;
border-color: var(–accent-purple);
box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.1);
}
.search-results {
max-height: 300px;
overflow-y: auto;
border: 1px solid var(–border-color);
border-radius: 12px;
background: var(–card-bg);
margin-top: 12px;
display: none;
}
.search-results.show {
display: block;
}
.search-result-item {
padding: 12px 16px;
cursor: pointer;
transition: background 0.2s ease;
border-bottom: 1px solid var(–border-color);
display: flex;
align-items: center;
gap: 12px;
}
.search-result-item:last-child {
border-bottom: none;
}
.search-result-item:hover {
background: var(–hover-bg);
}
.search-result-item.selected {
background: rgba(155, 89, 182, 0.1);
}
.result-checkbox {
width: 20px;
height: 20px;
border: 2px solid var(–border-color);
border-radius: 6px;
flex-shrink: 0;
position: relative;
transition: all 0.2s ease;
}
.search-result-item.selected .result-checkbox {
background: var(–accent-purple);
border-color: var(–accent-purple);
}
.result-checkbox::after {
content: ‘\f00c’;
font-family: ‘Font Awesome 6 Free’;
font-weight: 900;
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%) scale(0);
color: white;
font-size: 12px;
transition: transform 0.2s ease;
}
.search-result-item.selected .result-checkbox::after {
transform: translate(-50%, -50%) scale(1);
}
.result-info {
flex: 1;
min-width: 0;
}
.result-title {
font-size: 14px;
font-weight: 600;
color: var(–text-primary);
margin-bottom: 2px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
.result-meta {
font-size: 12px;
color: var(–text-secondary);
}
.search-empty {
padding: 40px 20px;
text-align: center;
color: var(–text-secondary);
}
.search-empty i {
font-size: 32px;
margin-bottom: 12px;
opacity: 0.5;
}
/* Selected Articles */
.selected-articles {
margin-top: 20px;
}
.selected-count {
font-size: 14px;
font-weight: 600;
color: var(–text-primary);
margin-bottom: 12px;
}
.selected-list {
list-style: none;
display: flex;
flex-direction: column;
gap: 8px;
}
.selected-item {
background: var(–hover-bg);
border: 1px solid var(–border-color);
border-radius: 12px;
padding: 12px 16px;
display: flex;
align-items: center;
gap: 12px;
}
.selected-item-info {
flex: 1;
min-width: 0;
}
.selected-item-title {
font-size: 14px;
font-weight: 600;
color: var(–text-primary);
margin-bottom: 2px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
.selected-item-meta {
font-size: 12px;
color: var(–text-secondary);
}
.remove-btn {
width: 32px;
height: 32px;
border-radius: 50%;
background: transparent;
border: none;
color: #ef4444;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s ease;
flex-shrink: 0;
}
.remove-btn:hover {
background: rgba(239, 68, 68, 0.1);
}
.empty-selection {
text-align: center;
padding: 32px 20px;
color: var(–text-secondary);
background: var(–bg-color);
border-radius: 12px;
border: 2px dashed var(–border-color);
}
.empty-selection i {
font-size: 32px;
margin-bottom: 12px;
opacity: 0.5;
}
/* Action Buttons */
.form-actions {
display: flex;
gap: 16px;
padding-top: 32px;
border-top: 1px solid var(–border-color);
}
.btn-cancel, .btn-create {
flex: 1;
padding: 16px 32px;
border-radius: 12px;
font-size: 16px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s ease;
border: none;
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
}
.btn-cancel {
background: var(–card-bg);
color: var(–text-primary);
border: 2px solid var(–border-color);
}
.btn-cancel:hover {
background: var(–hover-bg);
}
.btn-create {
background: linear-gradient(135deg, var(–accent-purple) 0%, #8e44ad 100%);
color: white;
box-shadow: 0 4px 12px rgba(155, 89, 182, 0.4);
}
.btn-create:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(155, 89, 182, 0.5);
}
.btn-create:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}
/* Loading State */
.loading-state {
text-align: center;
padding: 60px 20px;
color: var(–text-secondary);
}
.loading-spinner {
width: 48px;
height: 48px;
margin: 0 auto 20px;
border: 4px solid var(–border-color);
border-top-color: var(–accent-purple);
border-radius: 50%;
animation: spin 0.8s linear infinite;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
/* Success Message */
.success-message {
display: none;
text-align: center;
padding: 60px 20px;
}
.success-message.show {
display: block;
}
.success-icon {
width: 80px;
height: 80px;
background: linear-gradient(135deg, var(–accent-green) 0%, #27ae60 100%);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
margin: 0 auto 24px;
font-size: 36px;
color: white;
animation: scaleIn 0.5s ease;
}
@keyframes scaleIn {
from { transform: scale(0); }
to { transform: scale(1); }
}
.success-title {
font-size: 28px;
font-weight: 700;
margin: 0 0 12px 0;
color: var(–text-primary);
}
.success-text {
font-size: 16px;
color: var(–text-secondary);
margin-bottom: 32px;
}
.btn-view {
padding: 16px 32px;
border-radius: 12px;
background: linear-gradient(135deg, var(–accent-purple) 0%, #8e44ad 100%);
color: white;
font-size: 16px;
font-weight: 700;
border: none;
cursor: pointer;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
gap: 10px;
}
.btn-view:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(155, 89, 182, 0.5);
}
/* Footer Bar Navigation */
.footer-bar {
position: fixed;
bottom: 0;
left: 50%;
transform: translateX(-50%);
width: 100%;
max-width: 450px;
background: var(–card-bg);
border-top: 1px solid var(–border-color);
padding: 8px 24px;
padding-bottom: calc(8px + env(safe-area-inset-bottom));
display: flex;
justify-content: space-around;
align-items: center;
z-index: 100;
}
.footer-btn {
display: flex;
flex-direction: column;
align-items: center;
gap: 2px;
background: none;
border: none;
color: var(–text-secondary);
cursor: pointer;
transition: color 0.2s ease;
padding: 6px 12px;
}
.footer-btn:hover {
color: var(–text-primary);
}
.footer-btn.active {
color: var(–accent);
}
.footer-btn i {
font-size: 20px;
}
.footer-btn span {
font-size: 10px;
font-weight: 500;
}
/* Responsive */
@media (max-width: 768px) {
.main-container {
padding: 80px 16px 100px;
}
.page-title {
font-size: 32px;
}
.page-subtitle {
font-size: 15px;
}
.form-card {
padding: 28px 20px;
}
.form-actions {
flex-direction: column;
}
.btn-cancel, .btn-create, .btn-view {
width: 100%;
}
.footer-bar {
padding: 8px 16px;
padding-bottom: calc(8px + env(safe-area-inset-bottom));
}
.footer-btn {
padding: 6px 8px;
}
.footer-btn i {
font-size: 18px;
}
.footer-btn span {
font-size: 9px;
}
}
</style>
</head>
<body>
<script>
if (localStorage.getItem("theme") === "light") {
  document.body.classList.add("light-theme");
}
</script><div class="header-wrapper">
  <div class="header">
    <img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo" onclick="window.location.href='index.html'">
    <div class="header-actions">
      <div class="user-welcome" id="userWelcome">
        <span class="welcome-text" id="welcomeText">Welcome</span>
      </div>
    </div>
  </div>
</div><div class="main-container">
  <div class="page-header">
    <div class="page-icon">
      <i class="fas fa-bookmark"></i>
    </div>
    <h1 class="page-title">Create Library</h1>
    <p class="page-subtitle">Organize your favorite articles into collections that you can share and revisit anytime.</p>
  </div><div id="mainContent">
    <div class="form-card">
      <form id="libraryForm">
        <!-- Library Details Section -->
        <div class="form-section">
          <h2 class="section-title">
            <div class="section-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            Library Details
          </h2>

      <div class="form-group">
        <label class="form-label" for="libraryName">
          Name<span class="form-label-required">*</span>
        </label>
        <input 
          type="text" 
          id="libraryName" 
          class="form-input" 
          placeholder="My Awesome Collection"
          maxlength="100"
          required
        >
        <div class="char-count"><span id="nameCount">0</span>/100</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="libraryDescription">
          Description
        </label>
        <textarea 
          id="libraryDescription" 
          class="form-textarea" 
          placeholder="What's this library about? Add a description to help others understand your collection..."
          maxlength="500"
        ></textarea>
        <div class="char-count"><span id="descCount">0</span>/500</div>
      </div>
    </div>

    <!-- Add Articles Section -->
    <div class="form-section">
      <h2 class="section-title">
        <div class="section-icon">
          <i class="fas fa-plus"></i>
        </div>
        Add Articles
      </h2>

      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          id="articleSearch" 
          class="search-input" 
          placeholder="Search articles by title..."
        >
      </div>

      <div class="search-results" id="searchResults"></div>

      <div class="selected-articles">
        <div class="selected-count" id="selectedCount">0 articles selected</div>
        <ul class="selected-list" id="selectedList">
          <div class="empty-selection">
            <i class="fas fa-file-alt"></i>
            <div>No articles selected yet</div>
            <div style="font-size: 12px; margin-top: 4px;">Search and select articles to add them to your library</div>
          </div>
        </ul>
      </div>
    </div>

    <!-- Actions -->
    <div class="form-actions">
      <button type="button" class="btn-cancel" onclick="window.history.back()">
        <i class="fas fa-times"></i>
        Cancel
      </button>
      <button type="submit" class="btn-create" id="createBtn">
        <i class="fas fa-bookmark"></i>
        Create Library
      </button>
    </div>
  </form>
</div>


</div><!-- Success Message (hidden by default) --><div class="success-message" id="successMessage">
    <div class="success-icon">
      <i class="fas fa-check"></i>
    </div>
    <h2 class="success-title">Library Created!</h2>
    <p class="success-text">Your library has been successfully created and is ready to share.</p>
    <button class="btn-view" id="viewLibraryBtn">
      <i class="fas fa-eye"></i>
      View Library
    </button>
  </div>
</div><!-- Footer Bar Navigation --><div class="footer-bar">
  <button class="footer-btn" onclick="window.location.href='index.html'">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='https://patholytica.com/dailyfeed'">
    <i class="fas fa-scroll"></i>
    <span>Feed</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='explore.html'">
    <i class="fas fa-search"></i>
    <span>Explore</span>
  </button>
  <button class="footer-btn" onclick="window.location.href='profile.html'">
    <i class="fas fa-user"></i>
    <span>Profile</span>
  </button>
</div><script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Initialize Supabase
const SUPABASE_URL = "https://vduqewqyvszfquntmark.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdXFld3F5dnN6ZnF1bnRtYXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MTg3MjgsImV4cCI6MjA4NTE5NDcyOH0.V2JellFmUGgYhKfW-D4CBdcBHyPztOlcgLCBdhnXj7c";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Global variables
let currentUser = null;
let currentUserData = null;
let selectedArticles = [];
let allArticles = [];
let searchTimeout;
let createdLibraryId = null;

// DOM Elements
const libraryNameInput = document.getElementById('libraryName');
const libraryDescInput = document.getElementById('libraryDescription');
const articleSearchInput = document.getElementById('articleSearch');
const searchResults = document.getElementById('searchResults');
const selectedList = document.getElementById('selectedList');
const selectedCount = document.getElementById('selectedCount');
const libraryForm = document.getElementById('libraryForm');
const createBtn = document.getElementById('createBtn');
const mainContent = document.getElementById('mainContent');
const successMessage = document.getElementById('successMessage');
const viewLibraryBtn = document.getElementById('viewLibraryBtn');

// Character counters
libraryNameInput.addEventListener('input', (e) => {
  document.getElementById('nameCount').textContent = e.target.value.length;
});

libraryDescInput.addEventListener('input', (e) => {
  document.getElementById('descCount').textContent = e.target.value.length;
});

// Article search
articleSearchInput.addEventListener('input', (e) => {
  const query = e.target.value.trim();
  
  clearTimeout(searchTimeout);
  
  if (query.length < 2) {
    searchResults.classList.remove('show');
    return;
  }
  
  searchTimeout = setTimeout(() => {
    searchArticles(query);
  }, 300);
});

async function searchArticles(query) {
  try {
    const { data: articles, error } = await supabase
      .from('articles')
      .select('id, title, created_at, views')
      .ilike('title', `%${query}%`)
      .limit(20);

    if (error) throw error;

    if (!articles || articles.length === 0) {
      searchResults.innerHTML = `
        <div class="search-empty">
          <i class="fas fa-search"></i>
          <div>No articles found</div>
        </div>
      `;
      searchResults.classList.add('show');
      return;
    }

    searchResults.innerHTML = '';
    articles.forEach(article => {
      const isSelected = selectedArticles.some(a => a.id === article.id);
      const date = new Date(article.created_at);
      const formattedDate = date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      });

      const item = document.createElement('div');
      item.className = `search-result-item ${isSelected ? 'selected' : ''}`;
      item.innerHTML = `
        <div class="result-checkbox"></div>
        <div class="result-info">
          <div class="result-title">${escapeHtml(article.title)}</div>
          <div class="result-meta">${formattedDate} • ${article.views || 0} views</div>
        </div>
      `;
      
      item.onclick = () => toggleArticle(article);
      searchResults.appendChild(item);
    });

    searchResults.classList.add('show');
  } catch (error) {
    console.error('Error searching articles:', error);
  }
}

function toggleArticle(article) {
  const index = selectedArticles.findIndex(a => a.id === article.id);
  
  if (index > -1) {
    // Remove article
    selectedArticles.splice(index, 1);
  } else {
    // Add article
    selectedArticles.push(article);
  }
  
  updateSelectedList();
  
  // Update search results if visible
  if (searchResults.classList.contains('show')) {
    const items = searchResults.querySelectorAll('.search-result-item');
    items.forEach(item => {
      const title = item.querySelector('.result-title').textContent;
      const isSelected = selectedArticles.some(a => a.title === title);
      if (isSelected) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
    });
  }
}

function updateSelectedList() {
  selectedCount.textContent = `${selectedArticles.length} article${selectedArticles.length !== 1 ? 's' : ''} selected`;
  
  if (selectedArticles.length === 0) {
    selectedList.innerHTML = `
      <div class="empty-selection">
        <i class="fas fa-file-alt"></i>
        <div>No articles selected yet</div>
        <div style="font-size: 12px; margin-top: 4px;">Search and select articles to add them to your library</div>
      </div>
    `;
    return;
  }
  
  selectedList.innerHTML = '';
  selectedArticles.forEach(article => {
    const date = new Date(article.created_at);
    const formattedDate = date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });

    const item = document.createElement('li');
    item.className = 'selected-item';
    item.innerHTML = `
      <div class="selected-item-info">
        <div class="selected-item-title">${escapeHtml(article.title)}</div>
        <div class="selected-item-meta">${formattedDate} • ${article.views || 0} views</div>
      </div>
      <button type="button" class="remove-btn" data-id="${article.id}">
        <i class="fas fa-times"></i>
      </button>
    `;
    
    item.querySelector('.remove-btn').onclick = () => {
      selectedArticles = selectedArticles.filter(a => a.id !== article.id);
      updateSelectedList();
    };
    
    selectedList.appendChild(item);
  });
}

// Form submission
libraryForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const name = libraryNameInput.value.trim();
  const description = libraryDescInput.value.trim();
  
  if (!name) {
    alert('Please enter a library name');
    libraryNameInput.focus();
    return;
  }
  
  if (!currentUserData) {
    alert('Please log in to create a library');
    window.location.href = 'login.html';
    return;
  }
  
  createBtn.disabled = true;
  createBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; border-width: 3px; margin: 0;"></div> Creating...';
  
  try {
    // Create library
    const { data: library, error: libraryError } = await supabase
      .from('playlists')
      .insert([{
        user_id: currentUserData.user_id,
        name: name,
        description: description || null
      }])
      .select()
      .single();
    
    if (libraryError) throw libraryError;
    
    createdLibraryId = library.id;
    
    // Add articles to library
    if (selectedArticles.length > 0) {
      const playlistItems = selectedArticles.map(article => ({
        playlist_id: library.id,
        article_id: article.id
      }));
      
      const { error: itemsError } = await supabase
        .from('playlist_items')
        .insert(playlistItems);
      
      if (itemsError) throw itemsError;
    }
    
    // Show success message
    mainContent.style.display = 'none';
    successMessage.classList.add('show');
    
  } catch (error) {
    console.error('Error creating library:', error);
    alert('Failed to create library. Please try again.');
    createBtn.disabled = false;
    createBtn.innerHTML = '<i class="fas fa-bookmark"></i> Create Library';
  }
});

// View library button
viewLibraryBtn.onclick = () => {
  if (createdLibraryId) {
    window.location.href = `playlist.html?id=${createdLibraryId}`;
  }
};

// Helper function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Check authentication
onAuthStateChanged(auth, async (user) => {
  const userWelcome = document.getElementById('userWelcome');
  const welcomeText = document.getElementById('welcomeText');
  
  if (user) {
    currentUser = user;
    userWelcome.classList.add('show');
    
    try {
      const { data: userData, error } = await supabase
        .from('users')
        .select('*')
        .eq('firebase_uid', user.uid)
        .single();
      
      if (error) throw error;
      
      currentUserData = userData;
      welcomeText.textContent = `@${userData.username}`;
      welcomeText.onclick = () => window.location.href = 'profile.html';
      
    } catch (error) {
      console.error('Error fetching user data:', error);
      alert('Error loading user data. Please refresh the page.');
    }
  } else {
    // Redirect to login if not authenticated
    window.location.href = 'login.html';
  }
});

// Close search results when clicking outside
document.addEventListener('click', (e) => {
  if (!articleSearchInput.contains(e.target) && !searchResults.contains(e.target)) {
    searchResults.classList.remove('show');
  }
});
</script></body>
</html>